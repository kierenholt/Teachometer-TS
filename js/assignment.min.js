class ICup{constructor(parent,tagName,innerHTML){if(this._innerText="",this._events={},this.UID=null,this.attributes={},this.classes=[],this._parent=parent,this.tagName=tagName,this.UID=helpers.createUID(),parent){if(!(parent instanceof ICup))throw"bad parent";this.settings=parent.settings,window.cupsById[this.UID]=this}innerHTML&&(this._innerText=innerHTML)}get outerHTML(){return`<${this.tagName} id="${this.UID}" ${this.joinedEvents} ${this.joinedAttributes} ${this.joinedClasses}>${this.innerHTML}</${this.tagName}>`}get innerHTML(){return this._innerText}set innerHTML(value){this.getElement(!1)&&(this.getElement(!1).innerText=value),this._innerText=value}get joinedAttributes(){let buffer="";for(var key in this.attributes)-1!=ICup.propertiesNoValue.indexOf(key)?this.attributes[key]&&(buffer+=key+" "):buffer+=key+'="'+this.attributes[key]+'" ';return buffer}get joinedEvents(){let buffer="";for(var key in this._events)buffer+=` ${key}="window.cupsById['${this.UID}']._events['${key}'].forEach( e=> e() )" `;return buffer}get joinedClasses(){return this.classes.length>0?`class="${this.classes.join(" ")}" `:""}getAttribute(attName){return this.getElement(!1)?this._element[attName]:this.attributes[attName]}setAttribute(attName,value){return this.getElement(!1)&&(-1!=ICup.propertiesToSet.indexOf(attName)?this._element[attName]=value:this._element.setAttribute(attName,value)),this.attributes[attName]=value,this}addClass(className){return this.getElement(!1)&&this._element.classList.add(className),-1==this.classes.indexOf(className)&&this.classes.push(className),this}removeClass(className){return this.getElement(!1)&&this._element.classList.remove(className),helpers.removeFromArray(this.classes,className),this}setEvent(eventName,func){var eventArray;eventName in this._events||(this._events[eventName]=[]),this.getElement(!1)&&(this._element[eventName]=(eventArray=eventArray=this._events[eventName],()=>{eventArray.forEach(e=>e())})),this._events[eventName].push(func)}getElement(forceCreate){if(null!=this._element)return this._element;if(this._element=document.getElementById(this.UID),null==this._element&&forceCreate){this._element=document.createElement(this.tagName);for(let key in this.attributes)this._element.setAttribute(key,this.attributes[key]);for(let c of this.classes)this._element.classList.add(c);for(let key in this._events)this._element[key]=()=>{this._events[key].forEach(e=>e())};this._element.innerHTML=this.innerHTML}return this._element}detachFromParent(){this._parent.detachChildElement(this)}destroy(){this.getElement(!1)&&this._element.remove(),this._parent.detachChildElement(this),"destroy"in this._events&&this._events.destroy.forEach(f=>f(this))}onThisAndChildren(action){action(this)}}ICup.propertiesToSet=["checked","selected","value","disabled","src"],ICup.propertiesNoValue=["checked","selected","disabled"],ICup.cupsById={};class Span extends ICup{constructor(parent,innerText){super(parent,"span",innerText)}}class AnchorCup extends ICup{constructor(parent,url,innerText){super(parent,"a",innerText),this.attributes.href=url,this.attributes.target="_blank"}}class BreakCup extends ICup{constructor(parent){super(parent,"br")}}class UnderlineCup extends ICup{constructor(parent,str){super(parent,"u",str)}}class BoldCup extends ICup{constructor(parent,str){super(parent,"b",str)}}class SuperScriptCup extends ICup{constructor(parent,str){super(parent,"sup",str)}}class SubScriptCup extends ICup{constructor(parent,str){super(parent,"sub",str)}}class HeadingCup extends ICup{constructor(parent,str){super(parent,"h1",str)}}class ImageCup extends ICup{constructor(parent,src,alt,width){super(parent,"img"),(null==width||isNaN(width))&&(width=100),this.attributes.style=`position: relative; left:${50-width/2}%; width:${width}%`,this.attributes.src=src,alt&&(this.attributes.alt=alt),this.domain=helpers.getDomainFromUrl(src)}get HTML(){var cite="i.imgur.com"==this.domain?"":`<cite>Digital image taken from <a href=${this.attributes.src}>${this.domain}</a></cite>`;return`<${this.tagName} ${this.joinedAttributes} >${this.innerHTML}</${this.tagName}>${cite}`}}class ButtonCup extends ICup{constructor(parent,text){super(parent,"button"),this._innerText=text}}class OptionCup extends ICup{constructor(parent,value,isSelected){super(parent,"option",value),this.attributes.value=value,this.attributes.selected=isSelected}}class Container extends ICup{constructor(parent,tagName,childNodes){super(parent,tagName),this._childNodes=[],this._element=null,childNodes&&(this._childNodes=childNodes)}get innerHTML(){let ret="";for(var child of this._childNodes)ret+="string"==typeof child?child:child.outerHTML;return ret}set childNodes(value){this._childNodes=value}get childrenElementsOnly(){return this._childNodes.filter(c=>"string"!=typeof c)}appendChildren(nodes){for(let child of nodes)"string"==typeof child?this.appendChildString(child):this.appendChildElement(child);return this}appendChildElement(child,after){if(-1!=this._childNodes.indexOf(child)&&helpers.removeFromArray(this._childNodes,child),after&&this._childNodes.indexOf(after)<this._childNodes.length-1){if(this.getElement(!1)){let before=this._childNodes[this._childNodes.indexOf(after)+1];this._element.insertBefore(child.getElement(!0),before.getElement(!0))}helpers.insertAfter(this._childNodes,after,child)}else this.getElement(!1)&&this._element.appendChild(child.getElement(!0)),this._childNodes.push(child);return this}checkChildNodes(){if(this._element)for(let child of this._childNodes)if(!this._element.contains(child.getElement(!0)))throw"child not found in parent!"}appendChildString(child){return this._childNodes.push(child),this.refresh(),this}shuffleChildren(random){for(var i=this._childNodes.length-1;i>0;i--)this.appendChildElement(this._childNodes[random.next(i)])}detachChildElement(child){return helpers.removeFromArray(this._childNodes,child),this.refresh(),this}detachChildString(child){return helpers.removeFromArray(this._childNodes,child),this.refresh(),this}destroyChildAtIndex(index){let child=this._childNodes[index];return"string"==typeof child?(this.detachChildString(child),this.refresh()):this.detachChildElement(child),this}detachAllChildren(){return this._childNodes.forEach(c=>"string"==typeof c?this.detachChildString(c):this.detachChildElement(c)),this._childNodes=[],this.refresh(),this}refresh(){return this.getElement(!1)&&(this._element.innerHTML=this.innerHTML),this}destroy(){this.childrenElementsOnly.forEach(c=>c.destroy()),super.destroy()}destroyAllChildren(){this.childrenElementsOnly.forEach(c=>c.destroy()),this._childNodes=[],this.refresh()}onThisAndChildren(action){action(this),this.childrenElementsOnly.forEach(s=>s.onThisAndChildren(action))}stringToElements(markdown,replacer){let ret=[];for(let str of markdown.split(replacer.pattern))if(null!=str&&str.length>0)if(replacer.pattern.test(str)){let newChild=replacer.nodeConstructorFromMatch(this,str);newChild&&ret.push(...newChild)}else ret.push(str);return ret}replace(replacer){let newChildren=[];for(let child of this._childNodes)"string"==typeof child?newChildren.push(...this.stringToElements(child,replacer)):child.replace?(child.replace(replacer),newChildren.push(child)):newChildren.push(child);this._childNodes=newChildren}}class FractionCup extends Container{constructor(parent,topChildNodes,bottomChildNodes){super(parent,"table"),this.attributes.class="fraction",this.childNodes=["<tr><td>",...topChildNodes,"</td></tr><tr><td>",...bottomChildNodes,"</td></tr>"]}}class TableCup extends Container{constructor(parent,hasBorder,childNodes){super(parent,"table",childNodes),this.attributes.class="markdowntable",this.attributes.style=this.hasBorder?"":"border: none;"}static fromString(parent,hasBorder,str){let ret=new TableCup(parent,hasBorder,[]);return ret._childNodes=str.split("\n").map(s=>RowCup.fromString(ret,s)),ret}}class RowCup extends Container{constructor(parent,childNodes){super(parent,"tr",childNodes)}static fromString(parent,str){let ret=new RowCup(parent,[]);return ret._childNodes=str.split("|").slice(1).map(s=>new CellCup(ret,s)),ret}}class CellCup extends Container{constructor(parent,childNodes){super(parent,"td",childNodes)}}class RolloverCup extends Container{constructor(parent,childNodes){super(parent,"div",childNodes),this.attributes.class="rollover"}}class List extends ICup{constructor(parent,childNodes){super(parent,"li",childNodes)}}class CodeCup extends Container{constructor(parent,str){let lines=str.split("\n"),ret="";for(let i=0;i<lines.length;i++)ret+=1==i?`<span class="tr first-row"><span class="th"></span><code>${lines[i]}</code></span>`:`<span class="tr"><span class="th"></span><code>${lines[i]}</code></span>`;super(parent,"pre",[ret]),this.attributes.class="code",this.replace=null}}class RelativePositionCup extends Container{constructor(parent,xPos,yPos,childNodes){super(parent,"div",childNodes),this.attributes.style=`position:absolute;left:${xPos}%;top:${yPos}%`,this._parent.addClass("relative")}}class GridLines extends Container{constructor(parent){let childNodes;super(parent,"div",['\n        <div class="hgridline"><p>10%</p></div>\n        <div class="hgridline"><p>20%</p></div>\n        <div class="hgridline"><p>30%</p></div>\n        <div class="hgridline"><p>40%</p></div>\n        <div class="hgridline"><p>50%</p></div>\n        <div class="hgridline"><p>60%</p></div>\n        <div class="hgridline"><p>70%</p></div>\n        <div class="hgridline"><p>80%</p></div>\n        <div class="hgridline"><p>90%</p></div>\n        <div class="hgridline"><p>100%</p></div>\n        \n        <div class="vgridline"><p>10%</p></div>\n        <div class="vgridline"><p>20%</p></div>\n        <div class="vgridline"><p>30%</p></div>\n        <div class="vgridline"><p>40%</p></div>\n        <div class="vgridline"><p>50%</p></div>\n        <div class="vgridline"><p>60%</p></div>\n        <div class="vgridline"><p>70%</p></div>\n        <div class="vgridline"><p>80%</p></div>\n        <div class="vgridline"><p>90%</p></div>\n        <div class="vgridline"><p>100%</p></div>\n']),this.classes.push("gridlinecontainer")}toggleVisible(){if(this.getElement(!1)){let isVisible="block"==this._element.style.display;this._element.style.display=isVisible?"none":"block"}}}class Assignment extends Container{constructor(div,settingsObj){if(super(null,"div"),this._element=div,this.settings=settingsObj,this.settings.assignment=this,this._childNodes=[],this.settings.title&&(this._childNodes.push(new HeadingCup(this,this.settings.title)),window.document.title=this.settings.title),this.questionsDiv=new Container(this,"div").addClass("questionsDiv"),this._childNodes.push(this.questionsDiv),this.settings.shuffleQuestions&&this.shuffle(!1),this.settings.truncateMarks>0&&this.truncate(this.settings.truncateMarks),this.settings.presentMode?(this.questionsDiv.addClass("slides"),this.getElement(!0).classList.add("reveal")):(this.settings.studentPicker&&this._childNodes.push(this.settings.studentPicker.createCombo(this)),this.settings.instantChecking||(this.submitButtonAndFinalScoreLogic=new SubmitButtonAndFinalScoreLogic(this.settings),this.submitButtonDiv=this.submitButtonAndFinalScoreLogic.createDiv(this),this._childNodes.push(this.submitButtonDiv)),this.settings.showSolutions&&(this.solutionsDiv=new Container(this,"div").addClass("solutionsDiv"),this._childNodes.push(new HeadingCup(this,"solutions")),this._childNodes.push(this.solutionsDiv)),this.settings.timerLogic&&this._childNodes.push(this.settings.timerLogic.createDiv(this)),this.settings.sheetManager&&this._childNodes.push(this.settings.sheetManager.createCountdownDiv(this))),this.settings.questionJSON){var rows=JSON.parse(this.settings.questionJSON);this.addRowsFromData(rows)}this.refresh(),this.settings.presentMode&&window.Reveal.initialize({transition:"linear"})}addRowsFromData(rowData){for(var row of rowData){let QL=new QuestionLogic(row,this.settings),QD=QL.createQuestionDiv(this.questionsDiv);if(this.questionsDiv.appendChildElement(QD),this.solutionsDiv){let SD=QL.createSolutionDiv(this.solutionsDiv);this.solutionsDiv.appendChildElement(SD)}}}duplicateRow(QL){let newQL=new QuestionLogic(QL.rowData,this.settings,QL),newQD=newQL.createQuestionDiv(this.questionsDiv);this.questionsDiv.appendChildElement(newQD,QL.questionDiv);let newSD=newQL.createSolutionDiv(this.questionsDiv);this.solutionsDiv&&this.solutionsDiv.appendChildElement(newSD,QL.solutionDiv)}shuffle(shuffleQuestionNumbers){let seed=this.settings.random.next();this.questionsDiv.shuffleChildren(new Random(seed)),this.solutionsDiv&&this.solutionsDiv.shuffleChildren(new Random(seed)),shuffleQuestionNumbers&&(helpers.shuffleInPlace(QuestionNumberLogic.instances,new Random(seed)),QuestionNumberLogic.instances.forEach(q=>q.refreshSpans()))}resetQuestionOrder(){for(let ql of QuestionLogic.readOnlyInstances)this.questionsDiv.appendChildElement(ql.questionDiv),this.solutionsDiv&&this.solutionsDiv.appendChildElement(ql.solutionDiv)}deleteAll(){QuestionLogic.readOnlyInstances.forEach(ql=>ql.destroy())}scroll(){this.questionsDiv._element.lastElementChild.scrollIntoView()}truncate(n){null==n&&(n=prompt("enter number of marks you want left over","10"));let i=0;for(;QuestionLogic.readOnlyInstances[i]&&n>=helpers.lengthOfObject(QuestionLogic.readOnlyInstances[i].commentLogic.scoreLogicsWithCommentLetters);)n-=helpers.lengthOfObject(QuestionLogic.readOnlyInstances[i].commentLogic.scoreLogicsWithCommentLetters),i++;let lastQn=QuestionLogic.readOnlyInstances[i];if(lastQn){let scoreLogics=helpers.getValuesFromObject(lastQn.commentLogic.scoreLogicsWithCommentLetters);n>0&&lastQn.commentLogic.truncate(scoreLogics.length-n),n>0&&i++,QuestionLogic.readOnlyInstances.slice(i).forEach(ql=>ql.destroy())}}regenerateAllQuestions(){CommentLogic.instances.forEach(c=>c.generateNewDollars())}previewInNewWindow(){let previewWindow=window.open("","","");previewWindow.document.write(`\n<html>\n<head>\n\n    <meta charset="UTF-8"> \n    <link id="style" rel="stylesheet" type="text/css" href="https://www.teachometer.co.uk/user/css/assignment.css">\n    <script src="https://www.teachometer.co.uk/user/js/assignment.min.js"><\/script>\n    <script async src="https://www.teachometer.co.uk/user/js/acorn_interpreter.js"><\/script>\n\n</head>\n\n<body onload="init()">\n    <div id="assignment"></div>\n    <script>\n\n        function init() {\n            var previewSettings = {\n                questionJSON: ${JSON.stringify(JSON.stringify(this.currentQuestionData))}\n            };\n\n        window.assignment = new Assignment(document.getElementById("assignment"),new Settings(previewSettings,4));\n        }\n    <\/script>\n</body>\n</html>\n`),previewWindow.document.close()}presentInNewWindow(){let previewWindow=window.open("","","");previewWindow.document.write(`\n<html>\n<head>\n\n    <meta charset="UTF-8"> \n    <link id="style" rel="stylesheet" type="text/css" href="https://www.teachometer.co.uk/user/css/reveal.css">\n    <script src="https://www.teachometer.co.uk/user/js/assignment.min.js"><\/script>\n    <script src="https://www.teachometer.co.uk/user/js/reveal.js"><\/script>\n    <script async src="https://www.teachometer.co.uk/user/js/acorn_interpreter.js"><\/script>\n\n</head>\n\n<body onload="init()">\n    <div id="assignment"></div>\n    <script>\n\n        function init() {\n            var revealSettings = {\n                questionJSON: ${JSON.stringify(JSON.stringify(this.currentQuestionData))},\n            };\n\n        window.assignment = new Assignment(document.getElementById("assignment"),new Settings(revealSettings,3));\n        }\n    <\/script>\n</body>\n</html>\n`),previewWindow.document.close()}get questionNumbers(){return QuestionLogic.readOnlyInstances.reduce((a,b)=>a.concat(b.columnHeaders),[])}get currentQuestionData(){return QuestionLogic.readOnlyInstances.map(ql=>ql.rowData)}}class JSFunction{constructor(code,JSName){try{this.interpreter=new Interpreter(code)}catch(e){throw new ExpressionError("Error: Bad code. \n Detail:  "+e.message,!0,!1)}this.code=code,this.JSName=JSName,this.cache={}}execute(parameters){let joinedParameters=parameters.map(a=>JSON.stringify(a)).join();if(joinedParameters in this.cache)return this.cache[joinedParameters];"console"!=this.JSName&&this.interpreter.appendCode(`\n              ${this.JSName}(${joinedParameters});`);var i=1e5;try{for(;i--&&this.interpreter.step(););}catch(e){throw new ExpressionError("Error:code did not execute completely\n Detail:  "+e.message,!0,!1)}if(-1==i)throw new ExpressionError("Error: Code contains an infinite loop",!0,!1);var evaluated=void 0;if(this.interpreter.value&&"Array"==this.interpreter.value.K){var t=0;let arr=[];for(;t in this.interpreter.value.a;)arr[t]=this.interpreter.value.a[t],t++;evaluated=JSON.stringify(arr)}else evaluated=JSON.stringify(this.interpreter.value);return this.cache[joinedParameters]=evaluated,evaluated}static generateDefaultCode(functionName){return"console"==functionName?"":`function ${functionName}() {\n\n//your code goes here\n        \n}`}}function trimAfterDoubleSlash(comment){let indexOfDoubleSlash=comment.indexOf("//");return-1!=indexOfDoubleSlash&&(comment=comment.substr(0,indexOfDoubleSlash)),comment}const ALLOWABLE_ERROR_FOR_CORRECT_ANSWER=.05;class CommentLogic{constructor(comment,valueFields,purpose,questionLogic){this.solutionLines={},this.solutionValueSpans={},this.inputsWithCommentLetters={},this.dollarCupsWithCommentLetters={},this.checkBoxesWithCommentLetters={},this.scoreLogicsWithCommentLetters={},this.jsFunctionNamesWithCommentLetters={},this.pastInputValuesWithLetters={},this.questionLogic=questionLogic,this.settings=questionLogic.settings,CommentLogic.instances.push(this),this.seed=this.settings.random.next();let commentsWithLetters={},variableNamesWithCommentLetters={};if("template"!=purpose&&"sudoku"!=purpose)this.engine=new SimpleEngine(comment);else{let splitComments=comment.split("\n");for(let i=0;i<splitComments.length;i++){let c=splitComments[i],codeMatches=c.match(/code\(\"([\S]+)\"\)/),variableMatches=c.match(/variable\(\"([\S]+)\"\)/),commentLetter=helpers.lowerCaseLetterFromIndex(i);codeMatches?this.jsFunctionNamesWithCommentLetters[commentLetter]=codeMatches[1].toLowerCase():variableMatches?variableNamesWithCommentLetters[commentLetter]=variableMatches[1]:commentsWithLetters[commentLetter]=c,this.engine=new ExpressionEngine(commentsWithLetters,this.jsFunctionNamesWithCommentLetters,variableNamesWithCommentLetters)}}if("sudoku"==purpose){let variablesToKeepAsDollars=this.engine.variablesToKeepAsDollars(this.seed);for(let i=0;i<variablesToKeepAsDollars.length;i++)variablesToKeepAsDollars[i]||(valueFields[i]=valueFields[i].swapForInput())}for(let i=0;i<valueFields.length;i++){let v=valueFields[i],commentLetter=helpers.lowerCaseLetterFromIndex(i);if((v instanceof ComboCup||v instanceof InputCup||v instanceof TextAreaCup||v instanceof RadioSet)&&(this.inputsWithCommentLetters[commentLetter]=v,this.settings.sheetManager))if(commentLetter in this.jsFunctionNamesWithCommentLetters)this.settings.sheetManager.registerField(v,this.questionLogic.rowData.title,this.jsFunctionNamesWithCommentLetters[commentLetter]);else if(commentLetter in variableNamesWithCommentLetters);else{let columnHeaderFirstPart=helpers.IsStringNullOrWhiteSpace(this.questionLogic.rowData.title)?this.questionLogic.questionNumberLogic.number.toString():this.questionLogic.rowData.title;this.settings.sheetManager.registerField(v,columnHeaderFirstPart)}v instanceof CheckBoxCup&&(this.checkBoxesWithCommentLetters[commentLetter]=v,this.settings.sheetManager&&this.settings.sheetManager.registerField(v,this.questionLogic.rowData.title)),v instanceof DollarCup&&(this.dollarCupsWithCommentLetters[commentLetter]=v),(v instanceof ComboCup||v instanceof InputCup||v instanceof TextAreaCup||v instanceof CheckBoxCup||v instanceof RadioSet)&&(commentLetter in this.jsFunctionNamesWithCommentLetters?v.setValue(JSFunction.generateDefaultCode(this.jsFunctionNamesWithCommentLetters[commentLetter])):commentLetter in variableNamesWithCommentLetters||(this.scoreLogicsWithCommentLetters[commentLetter]=new ScoreLogic(v,this.settings,questionLogic.questionDiv)))}for(let d of valueFields)(d instanceof ComboCup||d instanceof InputCup||d instanceof TextAreaCup||d instanceof RadioSet)&&d.setOnClickAway(function(commentLogic,field){var commentLogic=commentLogic,field,prevValue=(field=field).getValue();return()=>{field.getValue()&&prevValue!=field.getValue()&&(prevValue=field.getValue(),commentLogic.onResponseFieldClickAway())}}(this,d));let inputValues=this.getInputValues(),outputValues=this.calculate(inputValues);outputValues&&(this.updateDollars(outputValues),this.sendToScoreLogics(inputValues,outputValues),this.pastInputValuesWithLetters=inputValues)}generateNewDollars(){this.seed=Settings.instance.random.next();let outputValues=this.calculate(this.getInputValues());if(outputValues){this.updateDollars(outputValues);for(let key in this.solutionValueSpans)key in outputValues&&outputValues[key]&&(this.solutionValueSpans[key].innerHTML=outputValues[key])}}fieldHasChanged(letter){return this.pastInputValuesWithLetters[letter]!=this.getInputValues()[letter]}onResponseFieldClickAway(){let inputValues=this.getInputValues(),outputValues=this.calculate(inputValues);outputValues&&(this.updateDollars(outputValues),this.sendToScoreLogics(inputValues,outputValues),Settings.instance.sendScoresToMarksheet&&this.sendToSheetManager(inputValues),this.pastInputValuesWithLetters=inputValues)}sendToScoreLogics(inputValues,outputValues){for(let letter in this.inputsWithCommentLetters)if(!helpers.IsStringNullOrWhiteSpace(inputValues[letter])&&this.fieldHasChanged(letter)&&letter in this.scoreLogicsWithCommentLetters&&letter in outputValues){let isCorrect=this.internalIsCorrect(inputValues[letter],outputValues[letter]);this.scoreLogicsWithCommentLetters[letter].setCorrect(isCorrect)}for(let key in this.checkBoxesWithCommentLetters)key in outputValues&&this.scoreLogicsWithCommentLetters[key].setCorrect("true"==outputValues[key])}sendToSheetManager(inputValues){for(let letter in inputValues)!helpers.IsStringNullOrWhiteSpace(inputValues[letter])&&this.fieldHasChanged(letter)&&this.settings.sheetManager&&this.settings.sheetManager.addFieldToSendBuffer(this.inputsWithCommentLetters[letter],this.scoreLogicsWithCommentLetters[letter]);for(let key in this.checkBoxesWithCommentLetters)this.settings.sheetManager&&this.settings.sheetManager.addFieldToSendBuffer(this.checkBoxesWithCommentLetters[key],this.scoreLogicsWithCommentLetters[key]);this.settings.sheetManager.attemptToSend()}updateDollars(outputValues){for(let key in this.dollarCupsWithCommentLetters)key in outputValues&&this.dollarCupsWithCommentLetters[key].setValue(outputValues[key])}getInputValues(){let ret={};for(let key in this.inputsWithCommentLetters)ret[key]=this.inputsWithCommentLetters[key].getValue();return ret}calculate(inputValues){let outputs=null;try{outputs=this.engine.calculate(inputValues,this.seed)}catch(e){if(e instanceof ExpressionError&&e.isCritical)return this.questionLogic.questionDiv.contentDiv.destroyAllChildren(),this.questionLogic.questionDiv.contentDiv.appendChildString(`There is an error in this question's comment cell which is preventing it from calculating the solutions.\n Error detail: ${e.message}`),this.questionLogic.questionDiv.contentDiv.addClass("red"),null}this.questionLogic.questionDiv.contentDiv.removeClass("red");for(let letter in this.inputsWithCommentLetters)this.inputsWithCommentLetters[letter].resetError();for(let letter in this.checkBoxesWithCommentLetters)this.checkBoxesWithCommentLetters[letter].resetError();for(let letter in this.dollarCupsWithCommentLetters)this.dollarCupsWithCommentLetters[letter].resetError();for(let letter in outputs)letter in this.inputsWithCommentLetters&&outputs[letter]instanceof ExpressionError&&(this.inputsWithCommentLetters[letter].setErrorText(outputs[letter].message),outputs[letter]=""),letter in this.checkBoxesWithCommentLetters&&outputs[letter]instanceof ExpressionError&&(this.checkBoxesWithCommentLetters[letter].setErrorText(outputs[letter].message),outputs[letter]=""),letter in this.dollarCupsWithCommentLetters&&outputs[letter]instanceof ExpressionError&&(this.dollarCupsWithCommentLetters[letter].setErrorText(outputs[letter].message),outputs[letter]="");return outputs}createAndAppendSolutions(parent,questionNumberLogic){let outputValues=this.calculate(this.getInputValues());if(outputValues){let ret=[],i=0;for(var letter in this.scoreLogicsWithCommentLetters)if(letter in outputValues){let solutionLine=new Container(parent,"div");solutionLine.appendChildElement(questionNumberLogic.createSpan(solutionLine)),solutionLine.appendChildString(helpers.lowerCaseLetterFromIndex(i)+". ");let solutionValue=new Span(solutionLine,outputValues[letter]);solutionLine.appendChildElement(solutionValue),parent.appendChildElement(solutionLine),i++,this.solutionLines[letter]=solutionLine,this.solutionValueSpans[letter]=solutionValue}}}truncate(n){let letters=helpers.getKeysFromObject(this.scoreLogicsWithCommentLetters),i=letters.length-1;for(;n>0;){let letter=letters[i];this.scoreLogicsWithCommentLetters[letter].setImageField.destroy(),this.scoreLogicsWithCommentLetters[letter].destroy(),this.solutionLines[letter].destroy(),n--,i--}}disable(){helpers.getValuesFromObject(this.inputsWithCommentLetters).forEach(i=>i.setAttribute("disabled",!0))}internalIsCorrect(value,correctAnswer){return helpers.isNumeric(correctAnswer)?correctAnswer%1==0?this.isCorrectExact(value,correctAnswer):this.isCorrectWithin5Percent(value,correctAnswer):this.isCorrectString(value,correctAnswer)}isCorrectWithin5Percent(value,correctAnswer){return Math.abs(value-correctAnswer)<=Math.abs(ALLOWABLE_ERROR_FOR_CORRECT_ANSWER*correctAnswer)}isCorrectString(value,correctAnswer){return value.toLowerCase().replace("'","'")==correctAnswer.toLowerCase()}isCorrectExact(value,correctAnswer){return value==correctAnswer}destroy(){for(let key in this.scoreLogicsWithCommentLetters)this.scoreLogicsWithCommentLetters[key].destroy();helpers.removeFromArray(CommentLogic.instances,this)}}CommentLogic.instances=[];class Connection{constructor(url,user,workbookSheetString){Connection.instance=this,this.url=url,this.user=user,this.workbookSheetString=workbookSheetString}getMarkbookSettings(onSuccess,onFail,userOverride){var data={action:"getMarkbookSettings",workbookSheetString:this.workbookSheetString,user:userOverride||this.user};this.sendRequestAndFail(this.url,data,onSuccess,onFail)}checkRequest(onSuccess,onRetry){var object={action:"checkRequest",workbookSheetString:this.workbookSheetString,user:this.user,startTime:Number(Settings.instance.startTime)};this.sendRequestAndRetry(this.url,object,onSuccess,onRetry)}writeToSheet(scores,onSuccess,onRetry){var object={action:"writeToSheet",workbookSheetString:this.workbookSheetString,user:this.user,startTime:Number(Settings.instance.startTime),scores:JSON.stringify(scores)};this.sendRequestAndRetry(this.url,object,onSuccess,onRetry)}sendRequestAndFail(url,object,onSuccess,onFail){var queryString="?";for(var key in object)queryString+=key+"="+encodeURIComponent(object[key])+"&";let scriptElement=document.createElement("script");scriptElement.type="text/javascript",scriptElement.onerror=function(scriptElement,onFail){var onFail=onFail,scriptElement=scriptElement;return data=>{onFail&&onFail(data),document.body.removeChild(scriptElement)}}(scriptElement,onFail);let random=Math.random().toString().substring(2);window.callback=function(scriptElement,onSuccess){var scriptElement=scriptElement,onSuccess=onSuccess;return data=>{onSuccess(data),document.body.removeChild(scriptElement)}}(scriptElement,onSuccess),scriptElement.src=url+queryString+"prefix=callback",document.body.appendChild(scriptElement)}sendRequestAndRetry(url,object,onSuccess,onRetry){var queryString="?";for(var key in object)queryString+=key+"="+encodeURIComponent(object[key])+"&";let scriptElement=document.createElement("script");scriptElement.type="text/javascript",scriptElement.onerror=function(connection,object,onSuccess,scriptElement,onRetry){var connection=connection,object=object,onSuccess=onSuccess,scriptElement=scriptElement,onRetry=onRetry;return data=>{onRetry&&onRetry(data),document.body.removeChild(scriptElement),setTimeout(()=>connection.sendRequestAndRetry(url,object,onSuccess,onRetry),1e3)}}(this,object,onSuccess,scriptElement,onRetry);let random=Math.random().toString().substring(2);window.callback=function(scriptElement,onSuccess){var scriptElement=scriptElement,onSuccess=onSuccess;return data=>{onSuccess(data),document.body.removeChild(scriptElement)}}(scriptElement,onSuccess),scriptElement.src=url+queryString+"prefix=callback",document.body.appendChild(scriptElement)}}class ContentDiv extends Container{constructor(parent,questionTitleLogic,leftRightMarkdown){super(parent,"div"),this.gridlines=[],this.classes.push("content"),this.questionTitle=questionTitleLogic.createTitle(this),this.appendChildElement(this.questionTitle);let leftRightContents=[];for(let c of leftRightMarkdown)if(!helpers.IsStringNullOrWhiteSpace(c)){let div=new Container(this,"div",[c]);this.appendChildElement(div),leftRightContents.push(div)}1==leftRightContents.length&&leftRightContents[0].addClass("fullWidth"),2==leftRightContents.length&&(leftRightContents[0].addClass("leftHalfWidth"),leftRightContents[1].addClass("rightHalfWidth"));for(let replacer of ContentDiv.replacers)this.replace(replacer);if(this.settings.allowGridlines)for(let c of this._childNodes)if(c._childNodes.some(d=>d instanceof RelativePositionCup)){let gridLineDiv=new GridLines(c);c.addClass("relative"),c.appendChildElement(gridLineDiv),this.gridlines.push(gridLineDiv)}let descendants=helpers.getDescendants(this);var currentRadioSet=null;this.setValueFields=[];for(let d of descendants)d instanceof ComboCup||d instanceof InputCup||d instanceof TextAreaCup||d instanceof CheckBoxCup||d instanceof DollarCup?this.setValueFields.push(d):d instanceof RadioCup&&(currentRadioSet?(currentRadioSet.letterComesAfterLastInSet(d.letter)||(currentRadioSet=new RadioSet),currentRadioSet.addRadioCup(d)):(currentRadioSet=new RadioSet,this.setValueFields.push(currentRadioSet),currentRadioSet.addRadioCup(d)))}toggleGridlines(){this.gridlines.forEach(g=>g.toggleVisible())}}ContentDiv.replacers=[{pattern:/(\?{3,}[^\?]*\?{3,})/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"?"),[new RolloverCup(parent,[str])])},{pattern:/(\`{3,}[^\?]*\`{3,})/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"`"),[new CodeCup(parent,str)])},{pattern:/((?:^|\n)[\|¦](?:[^\n]|\n\|)*)/,nodeConstructorFromMatch:(parent,str)=>{let hasBorder=str.startsWith("|");return[TableCup.fromString(parent,hasBorder,str)]}},{pattern:/(?:^|\n)(@\[[0-9]+,[0-9]+\]\([^)]*\))/,nodeConstructorFromMatch:(parent,str)=>{let xPosAsString="",yPosAsString="",childrenAsString="";return[,xPosAsString,yPosAsString,childrenAsString]=str.split(/@\[([\-0-9]+),([\-0-9]+)\]\(([^)]*)\)/),[new RelativePositionCup(parent,xPosAsString,yPosAsString,[childrenAsString])]}},{pattern:/(?:^|\n)(\*[^\n]*)/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"*"),[new List(parent,[str])])},{pattern:/(\n)/,nodeConstructorFromMatch:(parent,str)=>[new BreakCup(parent)]},{pattern:/(~\[[^\]]*\]\((?:\\\)|[^)])*\))/,nodeConstructorFromMatch:(parent,str)=>{let top="",bottom="";return[,top,bottom]=str.split(/~\[([^\]]*)\]\(((?:\\\)|[^)])*)\)/),[new FractionCup(parent,[top],[bottom])]}},{pattern:/(\$\$)/,nodeConstructorFromMatch:(parent,str)=>{let span=new Span(parent,"");return[new DollarCup(parent,span),span]}},{pattern:/(?:[^\!]|^)(\[[^\]]*]\([^\)]*\))/,nodeConstructorFromMatch:(parent,str)=>{let text="",url="";return[,text,url]=str.split(/\[([^\]]*)]\(([^\)]*)\)/),url.startsWith("http://")||url.startsWith("https://")||(url="https://"+url),parent.settings.removeHyperlinks?null:[new AnchorCup(parent,url,text)]}},{pattern:/(!\[[^\]]*]\([^\)]*\))/,nodeConstructorFromMatch:(parent,str)=>{let comment="",source="";[,comment,source]=str.split(/!\[([^\]]*)]\(([^\)]*)\)/g);let commaIndex=comment.indexOf(","),width=-1!=commaIndex?Number(comment.substr(commaIndex+1)):void 0;return[new ImageCup(parent,source,comment,width)]}},{pattern:/(_{10,})/,nodeConstructorFromMatch:(parent,str)=>{let decisionImage=new Icon(parent,IconName.none),span=new Span(parent,"");return[new TextAreaCup(parent,decisionImage,span),new BreakCup(parent),decisionImage,span]}},{pattern:/(_{2,9})/,nodeConstructorFromMatch:(parent,str)=>{let decisionImage=new Icon(parent,IconName.none),size=str.length,span=new Span(parent,"");return[new InputCup(parent,size,decisionImage,span),decisionImage,span]}},{pattern:/(?:[^\!]|^)(\[\])/,nodeConstructorFromMatch:(parent,str)=>{let span=new Span(parent,"");return[new CheckBoxCup(parent,IconName.hourglass,span),span]}},{pattern:/(?:^|\s)([A-Z]\.)/,nodeConstructorFromMatch:(parent,str)=>{let decisionImage=new Icon(parent,IconName.none),span=new Span(parent,"");return[new RadioCup(parent,str[0],decisionImage,span),decisionImage,span]}},{pattern:/({[^}]+})/,nodeConstructorFromMatch:(parent,str)=>{let decisionImage=new Icon(parent,IconName.none);str=helpers.trimChar(str,"{"),str=helpers.trimChar(str,"}");let span=new Span(parent,"");return[new ComboCup(parent,[" ",str],decisionImage,span),decisionImage,span]}},{pattern:/((?:\n|^)#[^\n]+)/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"#"),[new HeadingCup(parent,str)])},{pattern:/(\^[\S]+)/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"^"),[new SuperScriptCup(parent,str)])},{pattern:/(\~[\S]+)/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"~"),[new SubScriptCup(parent,str)])},{pattern:/(\*[^*]+\*)/,nodeConstructorFromMatch:(parent,str)=>(str=helpers.trimChar(str,"*"),[new BoldCup(parent,str)])},{pattern:/(_[^_]+_)/,nodeConstructorFromMatch:(parent,str)=>[new UnderlineCup(parent,str)]}];class ExpressionError extends Error{constructor(message,paramFeedbackToUser,paramIsCritical){super(message),this.feedbackToUser=paramFeedbackToUser,this.isCritical=paramIsCritical}}class IExpression{constructor(i){this.variablesUsed={},this.i=i;for(let j=0;j<26;j++)this.variablesUsed[helpers.lowerCaseLetterFromIndex(j)]=!1}getValue(injector){return null==this._value&&(this._value=this.eval(injector)),this._value}replaceVariables(s,injector){let buffer="";for(let i=0;i<s.length;i++)if(!isAlpha(s[i])||1!=s.length&&"e"==s[i].toLowerCase()&&0!=i&&helpers.isNumeric(s[i-1]))"π"==s[i]?buffer+="3.14159265359":buffer+=s[i];else{if(!(s[i]in injector.allVariablesAndFunctions))throw new ExpressionError(`variable "${s[i]}" not found`,!0,!0);{this.variablesUsed[s[i]]=!0;let val=injector.allVariablesAndFunctions[s[i]];if(val instanceof IExpression)buffer+=JSONtoEval(val.getValue(injector));else{if("string"!=typeof val)throw null==val?new ExpressionError(`variable "${s[i]}" is undefined`,!0,!1):new ExpressionError(`variable "${s[i]}" not found`,!0,!0);buffer+=JSONtoEval(val)}}}return buffer}}function alphaIndex(str){if(isLowerAlpha(str))return str.charCodeAt(0)-97;if(isUpperAlpha(str))return str.charCodeAt(0)-65;throw new Error("function alphaindex called on non alphanumeric string")}function isAlpha(str){var code=str.charCodeAt(0);return code>=65&&code<=90||code>=97&&code<=122}function isLowerAlpha(str){var code=str.charCodeAt(0);return code>=97&&code<=122}function isUpperAlpha(str){var code=str.charCodeAt(0);return code>=65&&code<=90}function getDigits(n){return n<10?[n]:getDigits(Math.floor(n/10)).concat([n%10])}function HCF(a,b){return a<=0||b<=0?0:a<b?HCF(b,a):a%b==0?b:HCF(b,a%b)}function hcfMulti(args){for(var ret=args.splice(-1);args.length>0;){var arg;ret=HCF(ret,args.splice(-1))}return ret}function lcm(args){for(var ret=args.splice(-1);args.length>0;){var arg=args.splice(-1);ret=ret*arg/HCF(ret,arg)}return ret}function factorial(n){return n<2?1:n*factorial(n-1)}function binomial(x,N,p){return factorial(N)/factorial(N-x)/factorial(x)*Math.pow(p,x)*Math.pow(1-p,N-x)}function roundToSF(n,d){if(0==n)return n;var biggestTen=Math.floor(Math.log(Math.abs(n))/Math.LN10)+1;return Math.round(n*Math.pow(10,d-biggestTen))/Math.pow(10,d-biggestTen)}function JSONtoViewable(ret){return null==ret?"undefined":"false"===ret?"false":"true"===ret?"true":"string"==typeof(ret=JSON.parse(ret))?helpers.stripQuotes(ret):"number"==typeof ret?ret%1==0?ret.toString():helpers.removeCrazySigFigs(ret):ret?ret.toString():void 0}function compareobjects(A,B){return void 0===A||void 0===B?void 0===A&&void 0===B:A instanceof Array||B instanceof Array?A instanceof Array&&B instanceof Array&&(A.length==B.length&&A.every((function(e,i){return compareobjects(e,B[i])}))):A==B}function JSONtoEval(str){if(""==str||null==str)return"null";let obj=void 0;try{obj=JSON.parse(str)}catch(e){throw new ExpressionError("unable to parse JSON: "+str,!0,!1)}return"string"==typeof obj?str:!0===obj?"true":!1===obj?"false":str}function toExpressionTree(s,i,commaIsTerminator){let children=[],buffer="";for(;i<s.length&&")"!=s[i]&&"]"!=s[i]&&(1!=commaIsTerminator||","!=s[i])&&(i+1>=s.length||"/"!=s[i]||"/"!=s[i+1]);){if("("==s[i]){buffer.length>0&&children.push(buffer),buffer="";let expr=toExpressionTree(s,i+1);children.push(expr),i=expr.i}else if("["==s[i]){buffer.length>0&&children.push(buffer),buffer="";let expr=new ArrayExpression(s,i+1);children.push(expr),i=expr.i}else{if(i+1<s.length&&".."==s.substr(i,2)){if(buffer.length+children.length==0)throw new ExpressionError("Range expression missing something before ..",!0,!0);return children.push(buffer),new RangeExpression(new SimpleExpression(children,i),s,i)}if(","==s[i]){if(buffer.length+children.length==0)throw new ExpressionError("List expression missing something before ,",!0,!0);return children.push(buffer),new ListExpression(new SimpleExpression(children,i),s,i)}if('"'==s[i]){buffer.length>0&&children.push(buffer),buffer="";let expr=new QuoteExpression(s,i);children.push(expr),i=expr.i}else if(i+1<s.length&&isAlpha(s[i])&&isAlpha(s[i+1])){buffer.length>0&&children.push(buffer),buffer="";let expr=new FunctionExpression(s,i);children.push(expr),i=expr.i}else buffer+=s[i]}i++}return buffer.length>0&&children.push(buffer),new SimpleExpression(children,i)}class SimpleExpression extends IExpression{constructor(children,i){super(i),this.children=children}eval(injector){if(injector.count(),1==this.children.length&&"string"!=typeof this.children[0])return this.children[0].eval(injector);let buffer="";for(let i=0,expr;expr=this.children[i];i++)buffer+="string"==typeof expr?this.replaceVariables(expr,injector):JSONtoEval(expr.eval(injector));if(helpers.IsStringNullOrWhiteSpace(buffer))return"";buffer=helpers.replaceAll(buffer,"\t",""),buffer=helpers.replaceAll(buffer,"--","+");var evaluated=eval(buffer);return JSON.stringify(evaluated)}}class QuoteExpression extends IExpression{constructor(s,i){for(super(i),i++,this.s="";i<s.length&&'"'!=s[i];)this.s+=s[i],i++;this.i=i}eval(injector){return injector.count(),`"${this.s}"`}}class RangeExpression extends IExpression{constructor(firstBuffer,s,i){super(i),this.minExpr=firstBuffer,this.maxExpr=toExpressionTree(s,i+2),this.i=this.maxExpr.i}eval(injector){injector.count();let decimalmin=Number(this.minExpr.eval(injector)),decimalmax=Number(this.maxExpr.eval(injector)),min=Math.ceil(decimalmin),max=Math.floor(decimalmax);if(min>max){let tempSwapMinandMax=min;min=max,max=tempSwapMinandMax}let temp=min==max?min:min+injector.random.next(max-min+1);return JSON.stringify(temp)}}class ListExpression extends IExpression{constructor(firstBuffer,s,i){for(super(i),this.options=[],null!=firstBuffer&&this.options.push(firstBuffer);i<s.length&&")"!=s[i]&&(i+1>=s.length||"/"!=s[i]||"/"!=s[i+1]);){if(","!=s[i]&&0!=this.options.length)throw new ExpressionError("bad list",!0,!0);{","==s[i]&&i++;let expr=toExpressionTree(s,i,!0);this.options.push(expr),i=expr.i}}this.i=i}eval(injector){injector.count();let randomIndex=injector.indexForListEvaluation%this.options.length,evaluated;return this.options[randomIndex].eval(injector)}}class ArrayExpression extends IExpression{constructor(s,i){for(super(i),this.options=[];i<s.length&&"]"!=s[i]&&(i+1>=s.length||"/"!=s[i]||"/"!=s[i+1]);){if(","!=s[i]&&0!=this.options.length)throw new ExpressionError("bad array",!0,!0);{","==s[i]&&i++;let expr=toExpressionTree(s,i,!0);this.options.push(expr),i=expr.i}}this.i=i}eval(injector){let evaluated;return injector.count(),"["+this.options.map(o=>o.eval(injector)).join()+"]"}}class FunctionExpression extends IExpression{constructor(s,i){for(super(i),this.functionName="",this.functionNamePreserveCase="";i<s.length&&(isAlpha(s[i])||helpers.isNumeric(s[i]));)this.functionName+=s[i].toLowerCase(),this.functionNamePreserveCase+=s[i],i++;if("("!=s[i])if(this.i=i-1,"true"==this.functionName)this.eval=function(injector){return!0};else{if("false"!=this.functionName)throw new ExpressionError("string without following bracket",!0,!0);this.eval=function(injector){return!1}}else this.list=new ListExpression(null,s,i+1),this.i=this.list.i}eval(injector){if(injector.count(),"if"==this.functionName)return"true"==this.list.options[0].eval(injector)?this.list.options[1].eval(injector):this.list.options[2].eval(injector);let evaluatedParameters=this.list.options.map((function(o){var f=o.eval(injector);return JSON.parse(f)}));if("exponent"==this.functionName){let asExponent=evaluatedParameters[0].toExponential(),Eindex=asExponent.indexOf("e");return JSON.stringify(asExponent.substr(Eindex+1))}if("mantissa"==this.functionName){let asExponent=evaluatedParameters[0].toExponential(),Eindex=asExponent.indexOf("e");return JSON.stringify(asExponent.substr(0,Eindex))}if("tostandardform"==this.functionName){let ret=evaluatedParameters[0];return JSON.stringify(ret.toExponential().replace("e"," x 10^").replace("+",""))}if("includes"==this.functionName){var ret=evaluatedParameters[0].toString().includes(evaluatedParameters[1]);return JSON.stringify(ret)}if("maxlength"==this.functionName){if('"'==evaluatedParameters[0][0])return`"${evaluatedParameters[0].substr(1,evaluatedParameters[1])}"`;let ret=evaluatedParameters[0].toString().substr(0,evaluatedParameters[1]);return JSON.stringify(ret)}if("padleftzeroes"==this.functionName){let ret=evaluatedParameters[0].toString().padStart(evaluatedParameters[1],"0");return JSON.stringify(ret)}if("padrightzeroes"==this.functionName){let str=evaluatedParameters[0].toString();str.includes(".")||(str+=".");let ret=str.padEnd(evaluatedParameters[1],"0");return JSON.stringify(ret)}if("getdigit"==this.functionName){let n,ret=getDigits(evaluatedParameters[0])[evaluatedParameters[1]-1];return JSON.stringify(ret)}if("dayname"==this.functionName){let year=evaluatedParameters[0],month=evaluatedParameters[1],date=evaluatedParameters[2],today,ret=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(year,month-1,date).getDay()];return JSON.stringify(ret)}if("dayofyear"==this.functionName){let year=evaluatedParameters[0],month=evaluatedParameters[1],date=evaluatedParameters[2],firstOfYear=new Date(year,0,1),today=new Date(year,month-1,date),ret=Math.round((today.valueOf()-firstOfYear.valueOf())/864e5+1);return JSON.stringify(ret)}if("abs"==this.functionName){let ret=Math.abs(evaluatedParameters[0]);return JSON.stringify(ret)}if("mean"==this.functionName){let sum,ret=evaluatedParameters.reduce((function(acc,val){return acc+val}))/evaluatedParameters.length;return JSON.stringify(ret)}if("median"==this.functionName){evaluatedParameters.sort();let l=evaluatedParameters.length,ret=null;return ret=l%2==0?.5*(evaluatedParameters[l/2-1]+evaluatedParameters[l/2]):evaluatedParameters[(l-1)/2],JSON.stringify(ret)}if("lowerquartile"==this.functionName){evaluatedParameters.sort();let l=evaluatedParameters.length,ret=null;return ret=l%4==0?.5*(evaluatedParameters[l/4-1]+evaluatedParameters[l/4]):evaluatedParameters[Math.floor(l/4)],JSON.stringify(ret)}if("upperquartile"==this.functionName){evaluatedParameters.sort();let l=evaluatedParameters.length,ret=null;return ret=l%4==0?.5*(evaluatedParameters[3*l/4-1]+evaluatedParameters[3*l/4]):evaluatedParameters[Math.floor(3*l/4)],JSON.stringify(ret)}if("mode"==this.functionName){let freqs={};for(n of evaluatedParameters)n in freqs?freqs[n]+=1:freqs[n]=1;let bestF=0,best=-1,ret=null;for(var f in freqs)freqs[f]>bestF&&(bestF=freqs[f],ret=f);return JSON.stringify(ret)}if("max"==this.functionName){let best=evaluatedParameters[0];for(var i=1;i<evaluatedParameters.length;i++)evaluatedParameters[i]>best&&(best=evaluatedParameters[i]);return JSON.stringify(best)}if("min"==this.functionName){let best=evaluatedParameters[0];for(var i=1;i<evaluatedParameters.length;i++)evaluatedParameters[i]<best&&(best=evaluatedParameters[i]);return JSON.stringify(best)}if("hcf"==this.functionName){let ret=hcfMulti(evaluatedParameters);return JSON.stringify(ret)}if("coprime"==this.functionName){let denom=evaluatedParameters[0];if(denom<2)throw new ExpressionError("no smaller coprime number exists for "+denom,!0,!0);let guess=injector.random.next(denom-1)+1;for(;HCF(denom,guess)>1;)guess=injector.random.next(denom-1)+1;return JSON.stringify(guess)}if("roundtodp"==this.functionName){let mult=Math.pow(10,evaluatedParameters[1]),result=Math.round(evaluatedParameters[0]*mult)/mult;return JSON.stringify(result)}if("roundtosf"==this.functionName){var n=evaluatedParameters[0],d;return ret=roundToSF(n,evaluatedParameters[1]),JSON.stringify(ret)}if("factorial"==this.functionName){let ret=factorial(evaluatedParameters[0]);return JSON.stringify(ret)}if("includesign"==this.functionName){let sign,ret=`"${evaluatedParameters[0]<0?"-":"+"} ${Math.abs(evaluatedParameters[0]).toString()}"`;return JSON.stringify(ret)}if("includeoppsign"==this.functionName){let sign,ret=`"${evaluatedParameters[0]<0?"+ ":"- "} ${Math.abs(evaluatedParameters[0]).toString()}"`;return JSON.stringify(ret)}if("sind"==this.functionName){let ret=Math.sin(evaluatedParameters[0]/180*Math.PI);return JSON.stringify(ret)}if("cosd"==this.functionName){let ret=Math.cos(evaluatedParameters[0]/180*Math.PI);return JSON.stringify(ret)}if("tand"==this.functionName){let ret=Math.tan(evaluatedParameters[0]/180*Math.PI);return JSON.stringify(ret)}if("asind"==this.functionName){let ret=180*Math.asin(evaluatedParameters[0])/Math.PI;return JSON.stringify(ret)}if("acosd"==this.functionName){let ret=180*Math.acos(evaluatedParameters[0])/Math.PI;return JSON.stringify(ret)}if("atand"==this.functionName){let ret=0;if(1==evaluatedParameters.length&&(ret=180*Math.atan(evaluatedParameters[0])/Math.PI),2==evaluatedParameters.length){ret=180*Math.atan(evaluatedParameters[0]/evaluatedParameters[1])/Math.PI;let xIsPos=evaluatedParameters[0]>0,yIsPos=evaluatedParameters[1]>0;ret+=xIsPos?yIsPos?0:180:yIsPos?360:180}return JSON.stringify(ret)}if("choose"==this.functionName){var index;let ret=evaluatedParameters[evaluatedParameters[0]+1];return JSON.stringify(ret)}if("countif"==this.functionName){var target=evaluatedParameters[0];let ret=evaluatedParameters.slice(1).filter(e=>e==target).length;return JSON.stringify(ret)}if("large"==this.functionName){var l,index2=evaluatedParameters.length-evaluatedParameters[0];let ret=evaluatedParameters.slice(1).sort()[index2];return JSON.stringify(ret)}if("normalcdf"==this.functionName){var X=evaluatedParameters[0],T=1/(1+.2316419*Math.abs(X)),D,Prob=.3989423*Math.exp(-X*X/2)*T*(.3193815+T*(T*(1.781478+T*(1.330274*T-1.821256))-.3565638));return X>0&&(Prob=1-Prob),JSON.stringify(Prob)}if("binomial"==this.functionName){let x,N,p,ret=binomial(evaluatedParameters[0],evaluatedParameters[1],evaluatedParameters[2]);return JSON.stringify(ret)}if("binomialcdf"==this.functionName){let x=evaluatedParameters[0],N=evaluatedParameters[1],p=evaluatedParameters[2],ret=0;for(let i=0;i<=x;i++)ret+=binomial(i,N,p);return JSON.stringify(ret)}if("sgn"==this.functionName){let ret=0;return evaluatedParameters[0]<0&&(ret=-1),evaluatedParameters[0]>0&&(ret=1),JSON.stringify(ret)}if("lcm"==this.functionName){let ret=lcm(evaluatedParameters);return JSON.stringify(ret)}if("compareobjects"==this.functionName){let ret=compareobjects(evaluatedParameters[0],evaluatedParameters[1]);return JSON.stringify(ret)}if(injector.allVariablesAndFunctions[this.functionName]instanceof JSFunction)return injector.allVariablesAndFunctions[this.functionName].execute(evaluatedParameters);if("function"==typeof Math[this.functionName]){let ret=Math[this.functionName](evaluatedParameters[0],evaluatedParameters[1],evaluatedParameters[2]);return JSON.stringify(ret)}throw new ExpressionError(`custom function with name "${this.functionNamePreserveCase}" not defined`,!1,!1)}}class SimpleEngine{constructor(comment){this.correctAnswers={},this.comment=comment;let split=comment.split("\n");for(let i=0;i<split.length;i++)this.correctAnswers[helpers.lowerCaseLetterFromIndex(i)]=split[i]}calculate(inputs,seed){return this.correctAnswers}}class ExpressionEngine{constructor(commentsWithLetters,jsFunctionsWithLetters,variableNamesWithLetters){this.overflowCounter=0,this.OVERFLOW_LIMIT=1e3,this.allVariablesAndFunctions={},this.numVariables=0,this.jsFunctionsWithLetters=jsFunctionsWithLetters,this.variableNamesWithLetters=variableNamesWithLetters;for(let key in commentsWithLetters)this.allVariablesAndFunctions[key]=toExpressionTree(commentsWithLetters[key],0),this.numVariables++}count(){if(this.overflowCounter++>this.OVERFLOW_LIMIT)throw new ExpressionError("contains an infinite loop",!0,!0)}calculate(inputs,seed){this.random=new Random(seed),this.indexForListEvaluation=this.random.next(),this.overflowCounter=0;for(let letter in this.allVariablesAndFunctions)this.allVariablesAndFunctions[letter]instanceof IExpression&&(this.allVariablesAndFunctions[letter]._value=void 0);let outputs={};for(let letter in this.jsFunctionsWithLetters)if(inputs[letter]&&inputs[letter].length>0)try{let obj=new JSFunction(inputs[letter],this.jsFunctionsWithLetters[letter]);this.allVariablesAndFunctions[this.jsFunctionsWithLetters[letter]]=obj}catch(e){if(e instanceof ExpressionError){if(e.isCritical)throw e;outputs[letter]=e}}for(let letter in this.variableNamesWithLetters)this.allVariablesAndFunctions[this.variableNamesWithLetters[letter]]=inputs[letter];for(let key in this.allVariablesAndFunctions)if(this.allVariablesAndFunctions[key]instanceof IExpression)try{outputs[key]=JSONtoViewable(this.allVariablesAndFunctions[key].getValue(this))}catch(e){if(e instanceof ExpressionError){if(e.isCritical)throw e;outputs[key]=e}}return outputs}variablesToKeepAsDollars(seed){this.calculate({},0);let matrix=[],i=0;for(let key in this.allVariablesAndFunctions){let row=helpers.getValuesFromObject(this.allVariablesAndFunctions[key].variablesUsed);row[i]=!0,matrix.push(row.slice(0,this.numVariables)),i++}return this.showVariables(matrix,this.numVariables,new Random(seed))}showVariables(arr,numDollars,paramRandom){for(var colsToShow=arr[0].map(a=>!1),rowCol=0;rowCol<arr[0].length;rowCol++)colsToShow[rowCol]=1==arr[rowCol].filter(p=>p).length&&1==arr.filter(p=>p[rowCol]).length;arr=arr.filter(r=>r.filter(p=>p).length>1);for(var maxColsToShow=colsToShow.length-arr.length,backupArr=arr.map(row=>row.slice()),backupColsToShow=colsToShow.slice();arr.length>0||maxColsToShow<colsToShow.filter(p=>p).length;){maxColsToShow<colsToShow.filter(p=>p).length&&(arr=backupArr.map(row=>row.slice()),colsToShow=backupColsToShow.slice());for(var colsWithATrue=[],col=numDollars;col<arr[0].length;col++){for(var hasATrue=!1,row=0;row<arr.length;row++)hasATrue=hasATrue||arr[row][col];hasATrue&&colsWithATrue.push(col)}if(0==colsWithATrue.length)for(let col=0;col<numDollars;col++){for(var hasATrue=!1,row=0;row<arr.length;row++)hasATrue=hasATrue||arr[row][col];hasATrue&&colsWithATrue.push(col)}if(0==colsWithATrue.length)break;var colToRemove=colsWithATrue[Math.floor(paramRandom.next(colsWithATrue.length))];colsToShow[colToRemove]=!0,arr.forEach(f=>f[colToRemove]=!1);for(var rowsWithOneTrue=arr.filter(r=>1==r.filter(p=>p).length);rowsWithOneTrue.length>0;){for(var r=0;r<rowsWithOneTrue.length;r++){var row2,singleCol=rowsWithOneTrue[r].indexOf(!0);arr.forEach(f=>f[singleCol]=!1),arr=arr.filter(r=>r.filter(p=>p).length>0)}rowsWithOneTrue=arr.filter(r=>1==r.filter(p=>p).length)}}return colsToShow}}var helpersMaker=function(){var objToHash=function(obj,hash){return null==hash&&(hash=34898410941),stringToHash(JSON.stringify(obj),hash)},stringToHash=function(str,hash){if(null==hash&&(hash=34898410941),0==str.length)return hash;for(var i=0;i<str.length;i++){var char;hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash}return hash},createUID,shuffleInPlace,toShuffled,trimChar,IsStringNullOrEmpty,IsStringNullOrWhiteSpace,startsWith=function(a,ai,b,bi){return(0!=ai||0==bi)&&(0==bi?a[ai]==b[bi]:a[ai]==b[bi]&&startsWith(a,ai-1,b,bi-1))},replaceAll,stripQuotes,removeCrazySigFigs,isNumeric,getDescendants=function(div){let ret=[div];if(div instanceof Container)for(let child of div._childNodes)ret=ret.concat(getDescendants(child));return ret},getDomainFromUrl,insertAfter,insertBefore,getItemImmediatelyAfter,removeFromArray,lowerCaseLetterFromIndex,lengthOfObject,getValuesFromObject,getKeysFromObject,mergeObjects;return{objToHash:objToHash,IsStringNullOrEmpty:function(str){return null==str||null==str||"string"!=typeof str||0===str.length||!str.trim()},IsStringNullOrWhiteSpace:function(str){return null==str||null==str||"string"!=typeof str||""==str||0==str.trim().length},createUID:function(){return"ID"+Math.random().toString(36).substr(2,16)},shuffleInPlace:function(a,random){for(var i=a.length-1;i>0;i--){let index=random.next(i);a.push(a.splice(index,1)[0])}return a},replaceAll:function(within,toReplace,replaceWith){for(var ret="",i=0,toReplaceLength=toReplace.length;i<within.length;)startsWith(within,i+toReplaceLength-1,toReplace,toReplaceLength-1)?(ret+=replaceWith,i+=toReplaceLength):(ret+=within[i],i+=1);return ret},startsWith:startsWith,stripQuotes:function(str){return'"'===str.charAt(0)&&'"'===str.charAt(str.length-1)?str.substr(1,str.length-2):str.toString()},trimChar:function(str,char){for(var i=0;i<str.length&&str[i]==char;)i++;if(i==str.length)return"";for(var j=str.length-1;j>=0&&str[j]==char;)j--;return str.substring(i,j+1)},isNumeric:function(str){return!isNaN(parseFloat(str))&&isFinite(str)},getDescendants:getDescendants,getDomainFromUrl:function(url){var a=document.createElement("a");return a.setAttribute("href",url),a.hostname},insertAfter:function(arr,ref,item){let index=arr.indexOf(ref);arr=arr.splice(index+1,0,item)},insertBefore:function(arr,ref,item){let index=arr.indexOf(ref);arr=arr.splice(index,0,item)},getItemImmediatelyAfter:function(arr,after){let index=arr.indexOf(after);return-1==index?void 0:arr[index+1]},removeFromArray:function(array,item){for(let i=array.length;i>=0;i--)array[i]==item&&array.splice(i,1)},removeCrazySigFigs:function(n){return parseFloat(n).toPrecision(12)},lowerCaseLetterFromIndex:function(i){return String.fromCharCode(97+i)},toShuffled:function(a,random){let ret=[];for(let item of a){let index=random.next(a.length);for(;ret[index];)index++,index%=a.length;ret[index]=item}return ret},lengthOfObject:function(obj){let ret=0;for(let key in obj)ret++;return ret},getValuesFromObject:function(obj){let ret=[];for(let key in obj)ret.push(obj[key]);return ret},getKeysFromObject:function(obj){let ret=[];for(let key in obj)ret.push(key);return ret},mergeObjects:function(obj1,obj2){let ret={};for(let key in obj1)ret[key]=obj1[key];for(let key in obj2)ret[key]=obj2[key];return ret}}},helpers=helpersMaker(),IconName,Mode;class Random{constructor(seed){this._seed=seed||Random.generateSeed(),this._seed=this._seed%2147483647,this._seed<=0&&(this._seed+=2147483646)}next(limit){return null==limit&&(limit=2147483647),this._seed=16807*this._seed%2147483647,this._seed%limit}static generateSeed(){let now,seed=(new Date).getTime();return seed%=2147483647,seed<=0&&(seed+=2147483646),seed}}!function(IconName){IconName[IconName.cross=0]="cross",IconName[IconName.tick=1]="tick",IconName[IconName.star=2]="star",IconName[IconName.trash=3]="trash",IconName[IconName.duplicate=4]="duplicate",IconName[IconName.hourglass=5]="hourglass",IconName[IconName.error=6]="error",IconName[IconName.refresh=7]="refresh",IconName[IconName.grid=8]="grid",IconName[IconName.pin=9]="pin",IconName[IconName.none=10]="none"}(IconName||(IconName={}));class Icon extends ICup{constructor(parent,iconName){super(parent,"img"),this.setIconName(iconName)}getIconName(){return this.iconName}setIconName(value){this.iconName=value,value==IconName.none?(this.setAttribute("src",""),this.addClass("displayNone"),this.removeClass("displayInlineBlock")):(this.setAttribute("src",Icon.imageData[value]),this.removeClass("displayNone"),this.addClass("displayInlineBlock"))}}Icon.imageData=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIhSURBVDjLlZPrThNRFIWJicmJz6BWiYbIkYDEG0JbBiitDQgm0PuFXqSAtKXtpE2hNuoPTXwSnwtExd6w0pl2OtPlrphKLSXhx07OZM769qy19wwAGLhM1ddC184+d18QMzoq3lfsD3LZ7Y3XbE5DL6Atzuyilc5Ciyd7IHVfgNcDYTQ2tvDr5crn6uLSvX+Av2Lk36FFpSVENDe3OxDZu8apO5rROJDLo30+Nlvj5RnTlVNAKs1aCVFr7b4BPn6Cls21AWgEQlz2+Dl1h7IdA+i97A/geP65WhbmrnZZ0GIJpr6OqZqYAd5/gJpKox4Mg7pD2YoC2b0/54rJQuJZdm6Izcgma4TW1WZ0h+y8BfbyJMwBmSxkjw+VObNanp5h/adwGhaTXF4NWbLj9gEONyCmUZmd10pGgf1/vwcgOT3tUQE0DdicwIod2EmSbwsKE1P8QoDkcHPJ5YESjgBJkYQpIEZ2KEB51Y6y3ojvY+P8XEDN7uKS0w0ltA7QGCWHCxSWWpwyaCeLy0BkA7UXyyg8fIzDoWHeBaDN4tQdSvAVdU1Aok+nsNTipIEVnkywo/FHatVkBoIhnFisOBoZxcGtQd4B0GYJNZsDSiAEadUBCkstPtN3Avs2Msa+Dt9XfxoFSNYF/Bh9gP0bOqHLAm2WUF1YQskwrVFYPWkf3h1iXwbvqGfFPSGW9Eah8HSS9fuZDnS32f71m8KFY7xs/QZyu6TH2+2+FAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAGrSURBVDjLvZPZLkNhFIV75zjvYm7VGFNCqoZUJ+roKUUpjRuqp61Wq0NKDMelGGqOxBSUIBKXWtWGZxAvobr8lWjChRgSF//dv9be+9trCwAI/vIE/26gXmviW5bqnb8yUK028qZjPfoPWEj4Ku5HBspgAz941IXZeze8N1bottSo8BTZviVWrEh546EO03EXpuJOdG63otJbjBKHkEp/Ml6yNYYzpuezWL4s5VMtT8acCMQcb5XL3eJE8VgBlR7BeMGW9Z4yT9y1CeyucuhdTGDxfftaBO7G4L+zg91UocxVmCiy51NpiP3n2treUPujL8xhOjYOzZYsQWANyRYlU4Y9Br6oHd5bDh0bCpSOixJiWx71YY09J5pM/WEbzFcDmHvwwBu2wnikg+lEj4mwBe5bC5h1OUqcwpdC60dxegRmR06TyjCF9G9z+qM2uCJmuMJmaNZaUrCSIi6X+jJIBBYtW5Cge7cd7sgoHDfDaAvKQGAlRZYc6ltJlMxX03UzlaRlBdQrzSCwksLRbOpHUSb7pcsnxCCwngvM2Rm/ugUCi84fycr4l2t8Bb6iqTxSCgNIAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIwSURBVDjLlZLNS5RRFMafe9/3vjPOjI1jaKKEVH40tGgRBWEibfoPQoKkVdtoEQQF4T/QqkVtWrSTFrVsF1FgJbWpIAh1k2PNh+PrfL4f95zTQk0HHKkDD/cc7vP8uHCuEhF0q/KnmXNgGR248PZFN4/GISXMC8L89DBPV0Dp4/SsazJjrtfb9/vdxfn/BgjzY5M8Aq8nBya+V3h93vtnQHFxat4kszntJAAAxus1YvnZQV5V/jyTEZarwnwFLGeFZdT0ZFOJdD84qoCDOpQ7grZfRNj020JSEOKvwvxGiF+q0tL0N5PuO+Mk0nC0B0BDsYCCImyzAIktBBloMwKJLSgKYcMAcdhC2KpVlIig+H5qxcv0n0xmj4Gbq+BwC2wtJLbgHUlMEFJwUpMIGpto16u+kJzSACAk+WCzvNbe+AVljkOYIcQQou3TbvdOJo+g4aNdqzaF+PT43HJVA8DQpcVIiPPtaqlEUQzlDELsTpgYwgTAQIjQqlUCtpQfn1spdmxh+PJSQyw9CrbKgM7tvcISQAxlBhC3GuCYXk3cWP25m3M7dk88qbWBRDVApaATOSjPBdXXwYEP5QyCgvjE/kwHgInHtHYBnYA2owhrPiiuw0sOw3EZFEagIB7qChDiYaUcNIoFtP1KxCTPhWiDw7WbXk9vKpnOgsI4exjg6Mbq96YQPxm79uPOvqvbXx4O3KrF6w8osv2df17kr5YXJq7vnw/S0v3k7Ie7xtud/wAaRnP+Cw8iKQAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAFuSURBVBgZBcG/S1RxAADwz3teyp3XFUUWNVSoRGQR3dLQIESBbUZt9gekm9XW2lRbNDv0gxbJWoJoCcT+ABskTgcDDwLpOD19d+/73rfPJ4kAANaejUx03t5eBZIIgKe34r3JB7OTVVvZuzf9lderiKIoip7MLba+xY24H4v4N36PC635uSgFIJ2/Pz7ppH19w66aHk/nqQCfk8LU1BWJAyMyo3Y1bV2nwpeh8nxxthg+Vm+ZUFVKHDjhK1UqlJeK52E61LOkasOhRDAic8EWKp/qxaupmdOO6Fi3bVyiEAQdA6Th7tjMGYcyDTcdtWlUoqYtypHmjy/atadrX6JpU5QaMhDlSPNTFX9kMj0H6rr+gYFCjnSw3XNZ2y9dPfT1lUq5UkA6+Phb3TU3NJArHFeKhtTkSBc+rC//0NBQVbNmwphzGu5oCztUGDz8udydbSrlVmI9eSkIirzYKZokESw+yl+EdtgL75eWAID/yIWfXhcZhKEAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAy0lEQVQ4T63TMWoCQRQG4G9rzyCBgCGNR0ifJiCinSmCgVS2sfAWaQzYJRcQJNhbW5rWVpTUaZJCBrZYltnd6GbKmXkf/3vMJGqupGa9LLDCZQm4Rid/ngW+8IOPCNLFAddVwByPESDsh+LawAz9NGkP+3wLVQle8IwLtLE5FQgt3OOtCFjgITKDsN9KZzDAexHQwGcOCClD3G0VMEWz5B0EeIzCBNnaCW5xEwH/BLziCUt855DQzlVsBtl7IwxL2vnFHXb/+pnO+phHa64xEbM+Qh0AAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ6SURBVDjLjZO7T1NhGMY7Mji6uJgYt8bElTjof6CDg4sMSqIxJsRGB5F4TwQSIg1QKC0KWmkZEEsKtEcSxF5ohV5pKSicXqX3aqGn957z+PUEGopiGJ583/A+v3znvPkJAAjWR0VNJG0kGhKahCFhXcN3YBFfx8Kry6ym4xIzce88/fbWGY2k5WRb77UTTbWuYA9gDGg7EVmSIOF4g5T7HZKuMcSW5djWDyL0uRf0dCc8inYYxTcw9fAiCMBYB3gVj1z7gLhNTjKCqHkYP79KENC9Bq3uxrrqORzy+9D3tPAAccspVx1gWg0KbaZFbGllWFM+xrKkFQudV0CeDfJsjN4+C2nracjunoPq5VXIBrowMK4V1gG1LGyWdbZwCalsBYUyh2KFQzpXxVqkAGswD3+qBDpZwow9iYE5v26/VwfUQnnznyhvjguQYabIIpKpYD1ahI8UTT92MUSFuP5Z/9TBTgOgFrVjp3nakaG/0VmEfpX58pwzjUEquNk362s+PP8XYD/KpYTBHmRg9Wch0QX1R80dCZhYipudYQY2Auib8RmODVCa4hfUK4ngaiiLNFNFdKeCWWscXZMbWy9Unv9/gsIQU09a4pwvUeA3Uapy2C2wCKXL0DqTePLexbWPOv79E8f0UWrencZ2poxciUWZlKssB4bcHeE83NsFuMgpo2iIpMuNa1TNu4XjhggWvb+R2K3wZdLlAZl8Fd9jRb5sD+Xx0RJBx5gdom6VsMEFDyWF0WyCeSOFcDKPnRxZYTQL5Rc/nn1w4oFsBaIhC3r6FRh5erPRhYMyHdeFw4C6zkRhmijM7CnMu0AUZonCDCnRJBqSus5/ABD6Ba5CkQS8AAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIsSURBVDjLpVNLSJQBEP7+h6uu62vLVAJDW1KQTMrINQ1vPQzq1GOpa9EppGOHLh0kCEKL7JBEhVCHihAsESyJiE4FWShGRmauu7KYiv6Pma+DGoFrBQ7MzGFmPr5vmDFIYj1mr1WYfrHPovA9VVOqbC7e/1rS9ZlrAVDYHig5WB0oPtBI0TNrUiC5yhP9jeF4X8NPcWfopoY48XT39PjjXeF0vWkZqOjd7LJYrmGasHPCCJbHwhS9/F8M4s8baid764Xi0Ilfp5voorpJfn2wwx/r3l77TwZUvR+qajXVn8PnvocYfXYH6k2ioOaCpaIdf11ivDcayyiMVudsOYqFb60gARJYHG9DbqQFmSVNjaO3K2NpAeK90ZCqtgcrjkP9aUCXp0moetDFEeRXnYCKXhm+uTW0CkBFu4JlxzZkFlbASz4CQGQVBFeEwZm8geyiMuRVntzsL3oXV+YMkvjRsydC1U+lhwZsWXgHb+oWVAEzIwvzyVlk5igsi7DymmHlHsFQR50rjl+981Jy1Fw6Gu0ObTtnU+cgs28AKgDiy+Awpj5OACBAhZ/qh2HOo6i+NeA73jUAML4/qWux8mt6NjW1w599CS9xb0mSEqQBEDAtwqALUmBaG5FV3oYPnTHMjAwetlWksyByaukxQg2wQ9FlccaK/OXA3/uAEUDp3rNIDQ1ctSk6kHh1/jRFoaL4M4snEMeD73gQx4M4PsT1IZ5AfYH68tZY7zv/ApRMY9mnuVMvAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAI/SURBVDjLjZPbS9NhHMYH+zNidtCSQrqwQtY5y2QtT2QGrTZf13TkoYFlzsWa/tzcoR3cSc2xYUlGJfzAaIRltY0N12H5I+jaOxG8De+evhtdOP1hu3hv3sPzPO/z4SsBIPnfuvG8cbBlWiEVO5OUItA0VS8oxi9EdhXo+6yV3V3UGHRvVXHNfNv6zRfNuBZVoiFcB/3LdnQ8U+Gk+bhPVKB3qUOuf6/muaQR/qwDkZ9BRFdCmMr5EPz6BN7lMYylLGgNNaKqt3K0SKDnQ7us690t3rNsxeyvaUz+8OJpzo/QNzd8WTtcaQ7WlBmPvxhx1V2Pg7oDziIBimwwf3qAGWESkVwQ7owNujk1ztvk+cg4NnAUTT4FrrjqUKHdF9jxBfXr1rgjaSk4OlMcLrnOrJ7latxbL1V2lgvlbG9MtMTrMw1r1PImtfyn1n5q47TlBLf90n5NmalMtUdKZoyQMkLKlIGLjMyYhFpmlz3nGEVmFJlRZNaf7pIaEndM24XIjCOzjX9mm2S2JsqdkMYIqbB1j5C6yWzVk7YRFTsGFu7l+4nveExIA9aMCcOJh6DIoMigyOh+o4UryRWQOtIjaJtoziM1FD0mpE4uZcTc72gBaUyYKEI6khgqINXO3saR7kM8IZUVCRDS0Ucf+xFbCReQhr97MZ51wpWxYnhpCD3zOrT4lTisr+AJqVx0Fiiyr4/vhP4VyyMFIUWNqRrV96vWKXKckBoIqWzXYcoPDrUslDJoopuEVEpIB0sR+AuErIiZ6OqMKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAApklEQVQ4jb3SQQqBURTF8R99E0aSMrEFC7AGpvYmG1A2YgG2YCIDJSlRTF65fS4lcut1T+f/Ou/d1+O5ZkFPysoYqJKAbtCtNww0k4CP6uuABuboBG+EVdGD0jcJg30Wugx6WlbG8IMRKozRDt4gnDqq7Y8MThVOOAfz4jHbsfR9wuCa3eq/b9DAAr3gDbEuul/6NmGwy0L/O8JP/kG9DkGfcXvBwB3GoiAx97DmjwAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA6UlEQVQ4y2NgIBL8L2aUA+LrQOzGQCoAamIC4sNA/BeIv5NsCFBDFVSzHxCvhhriQqxmCyD+DcQ1QMwFxFuB+D8QfwViB2wa1IC4EYgXAvFUIL4PxNuBWASIj0I1w/BjdM0FUNtgCs4C8XMgvgvEV9E0XwRiPXQDjID4LVRBGBCzAPF0NI0gCzqBmA2Xn2GG3ATizWiaQS6xIibgkF2CjOcSo1kM6kQTLIasJybB7IYq7sfikl5CBjRDFZ4GYgU074ASkhE+zV5QRVPRQxhqSCOhjPIQiKPIyShs0FSnxUAOAMUrEPMwkAkABQjt40jPAagAAAAASUVORK5CYII="];class MarginDiv extends Container{constructor(parent,questionNumberLogic,questionLogic){if(super(parent,"div"),this.classes.push("margin"),this.classes.push("greyBackground"),questionNumberLogic){let questionNumberDiv=new Container(this,"div",[questionNumberLogic.createSpan(this)]);questionNumberDiv.addClass("questionNumber"),this.appendChildElement(questionNumberDiv)}if(this.settings.allowRowDelete){let deleteButton=new Icon(this,IconName.trash);deleteButton.setEvent("onclick",questionLogic.destroy.bind(questionLogic)),deleteButton.addClass("deleteButton").addClass("hideOnPrint"),this.appendChildElement(deleteButton)}if(this.settings.allowRowDuplicate){let duplicateButton=new Icon(this,IconName.duplicate);duplicateButton.setEvent("onclick",(ql=questionLogic,assignment=this.settings.assignment,ql=ql,assignment=assignment,()=>{assignment.duplicateRow(ql)})),duplicateButton.addClass("duplicateButton").addClass("hideOnPrint"),this.appendChildElement(duplicateButton)}var ql,assignment;let refreshButton=new Icon(this,IconName.refresh);if(refreshButton.setEvent("onclick",function(ql){var ql=ql;return()=>{questionLogic.commentLogic.generateNewDollars()}}(questionLogic)),refreshButton.addClass("refreshButton").addClass("hideOnPrint"),this.appendChildElement(refreshButton),parent.contentDiv.gridlines.length>0){let gridlinesButton=new Icon(this,IconName.grid);gridlinesButton.setEvent("onclick",(contentDiv=contentDiv=parent.contentDiv,()=>{contentDiv.toggleGridlines()})),gridlinesButton.addClass("gridlinesButton").addClass("hideOnPrint"),this.appendChildElement(gridlinesButton)}var contentDiv;let spotlightButton=new Icon(this,IconName.pin);spotlightButton.setEvent("onclick",function(ql){var ql=ql;return()=>{QuestionLogic.toggleHideAllQuestionsButOne(ql)}}(questionLogic)),spotlightButton.addClass("refreshButton").addClass("hideOnPrint"),this.appendChildElement(spotlightButton)}}class QuestionLogic{constructor(rowData,settings,after){this.rowData=rowData,this.settings=settings,this.questionNumberLogic=new QuestionNumberLogic(this.settings,!this.isQuestionOrTemplateOrSudoku,this,after?after.questionNumberLogic:null),this.questionTitleLogic=new QuestionTitleLogic(this.rowData.title,this.settings,after?after.questionTitleLogic:null)}static get readOnlyInstances(){return QuestionNumberLogic.instances.map(qnl=>qnl.questionLogic)}createQuestionDiv(parent){return this.settings.presentMode?this.questionDiv=new SectionDiv(parent,this.questionTitleLogic,this.questionNumberLogic,this.rowData.leftRight,this):this.questionDiv=new QuestionDiv(parent,this.questionTitleLogic,this.questionNumberLogic,this.rowData.leftRight,this),this.isQuestionOrTemplateOrSudoku&&(this.commentLogic=new CommentLogic(this.rowData.comment,this.questionDiv.contentDiv.setValueFields,this.rowData.purpose,this)),this.questionDiv}createSolutionDiv(parent){return this.solutionDiv=new SolutionDiv(parent,this.questionNumberLogic,this.commentLogic),this.solutionDiv}get isQuestionOrTemplateOrSudoku(){return-1!=QuestionLogic.purposesWithQuestionNumber.indexOf(this.rowData.purpose)}destroy(){this.questionTitleLogic.delete(),this.questionNumberLogic&&this.questionNumberLogic.destroy(),this.commentLogic&&this.commentLogic.destroy(),this.questionDiv.destroy(),this.solutionDiv&&this.solutionDiv.destroy()}get columnHeaders(){let ret=[];if(this.commentLogic)for(let letter in this.commentLogic.inputsWithCommentLetters){let field=this.commentLogic.inputsWithCommentLetters[letter],columnHeader=this.settings.sheetManager.columnHeadersWithFieldUIDs[field.UID];columnHeader&&ret.push(columnHeader)}return ret}static toggleHideAllQuestionsButOne(questionLogic){-1!=questionLogic.questionDiv.classes.indexOf("displayBlock")?QuestionLogic.readOnlyInstances.forEach(ql=>{ql.questionDiv.removeClass("displayNone"),ql.questionDiv.removeClass("displayBlock")}):(QuestionLogic.readOnlyInstances.filter(ql=>ql!=questionLogic).forEach(ql2=>{ql2.questionDiv.addClass("displayNone"),ql2.questionDiv.removeClass("displayBlock")}),questionLogic.questionDiv.addClass("displayBlock"),questionLogic.questionDiv.removeClass("displayNone"))}}QuestionLogic.purposesWithQuestionNumber=["question","sudoku","template"];class IQuestionOrSectionDiv extends Container{}class QuestionDiv extends IQuestionOrSectionDiv{constructor(parent,questionTitleLogic,questionNumberLogic,leftRightMarkdown,questionLogic){super(parent,"div"),this.classes.push("question"),this.classes.push("greyBorder"),this.contentDiv=new ContentDiv(this,questionTitleLogic,leftRightMarkdown),this.marginDiv=new MarginDiv(this,questionNumberLogic,questionLogic),this._childNodes=[this.contentDiv,this.marginDiv]}}class SectionDiv extends IQuestionOrSectionDiv{constructor(parent,questionTitleLogic,questionNumberLogic,leftRightMarkdown,questionLogic){super(parent,"section"),this.contentDiv=new ContentDiv(this,questionTitleLogic,leftRightMarkdown),this._childNodes=[this.contentDiv]}}class QuestionNumberLogic{constructor(settings,isBlank,questionLogic,after){this.spans=[],this.settings=settings,this.isBlank=isBlank,this.questionLogic=questionLogic,after?(helpers.insertAfter(QuestionNumberLogic.instances,after,this),QuestionNumberLogic.instances.forEach(qn=>qn.refreshSpans())):QuestionNumberLogic.instances.push(this)}get next(){let index=QuestionNumberLogic.instances.indexOf(this);return QuestionNumberLogic.instances[index+1]}get number(){if(this.isBlank)throw"blank question number being called!";let index=QuestionNumberLogic.instances.indexOf(this),numBlanks;return index+1-QuestionNumberLogic.instances.slice(0,index).filter(ql=>ql.isBlank).length}get prev(){let index=QuestionNumberLogic.instances.indexOf(this);return QuestionNumberLogic.instances[index-1]}createSpan(parent){var span=new Span(parent,this.isBlank?"":"Q"+this.number.toString());return this.spans.push(span),span}refreshSpans(){this.spans.forEach(span=>span.innerHTML=this.isBlank?"":"Q"+this.number.toString())}destroy(){helpers.removeFromArray(QuestionNumberLogic.instances,this),QuestionNumberLogic.instances.forEach(qn=>qn.refreshSpans())}}QuestionNumberLogic.instances=[];class QuestionTitleLogic{constructor(title,settings,after){this.value=title,this.settings=settings,after?(helpers.insertAfter(QuestionTitleLogic.instances,after,this),QuestionTitleLogic.instances.forEach(qn=>qn.refresh())):QuestionTitleLogic.instances.push(this)}createTitle(parent){if(this.div)throw"title already created";this.div=new Container(parent,"div");let span=new Span(this.div,this.value);return this.div.appendChildElement(span),span.addClass("questionTitle"),this.div}get next(){let index=QuestionTitleLogic.instances.indexOf(this);return QuestionTitleLogic.instances[index+1]}get prev(){let index=QuestionTitleLogic.instances.indexOf(this);return QuestionTitleLogic.instances[index-1]}refresh(){let hidden=!!this.prev&&this.prev.value==this.value;this.div&&(hidden?(this.div.addClass("displayNone"),this.div.removeClass("displayBlock")):(this.div.addClass("displayBlock"),this.div.removeClass("displayNone")))}delete(){helpers.removeFromArray(QuestionTitleLogic.instances,this),QuestionTitleLogic.instances.forEach(qn=>qn.refresh())}}QuestionTitleLogic.instances=[];class ComboCup extends Container{constructor(parent,childNodes,decisionImage,span){super(parent,"select",childNodes),this.replace(ComboCup.optionReplacer),this._decisionImage=decisionImage,this.errorText=span,this.errorText.addClass("errorText"),this.attributes.value=""}setOnClickAway(func){this.setEvent("onchange",func)}getValue(){return this.getAttribute("value")}setValue(value){this.setAttribute("value",value);let found=this._childNodes.filter(ch=>ch._innerText==value);found.length>0&&found[0].setAttribute("selected",!0)}setDecisionImage(value){this._decisionImage.setIconName(value)}setErrorText(value){this.errorText.innerHTML=value,value.length>0&&this._decisionImage.setIconName(IconName.error)}resetError(){this.errorText.innerHTML="",this._decisionImage.getIconName()==IconName.error&&this.setDecisionImage(IconName.none)}}ComboCup.optionReplacer={pattern:/(?:^|\/)([^\/]+)/,nodeConstructorFromMatch:(parent,str)=>[new OptionCup(parent,str,!1)]};class InputCup extends ICup{constructor(parent,size,decisionImage,span){super(parent,"input"),this.attributes.type="text",this.attributes.size=size.toString(),this._decisionImage=decisionImage,this.errorText=span,this.errorText.addClass("errorText"),this.attributes.value=""}setOnClickAway(func){this.setEvent("onblur",func)}getValue(){return this.getAttribute("value")}setValue(value){this.setAttribute("value",value)}setDecisionImage(value){this._decisionImage.setIconName(value)}setErrorText(value){this.errorText.innerHTML=value,value.length>0&&this._decisionImage.setIconName(IconName.error)}resetError(){this.errorText.innerHTML="",this._decisionImage.getIconName()==IconName.error&&this.setDecisionImage(IconName.none)}}class TextAreaCup extends ICup{constructor(parent,decisionImage,span){super(parent,"textarea"),this.attributes.rows="10",this._decisionImage=decisionImage,this.errorText=span,this.errorText.addClass("errorText")}setOnClickAway(func){this.setEvent("onblur",func)}getValue(){return this.getAttribute("value")}setValue(value){this.innerHTML=value}setDecisionImage(value){this._decisionImage.setIconName(value)}setErrorText(value){this.errorText.innerHTML=value,value.length>0&&this._decisionImage.setIconName(IconName.error)}resetError(){this.errorText.innerHTML="",this._decisionImage.getIconName()==IconName.error&&this.setDecisionImage(IconName.none)}}class RadioSet{constructor(){this.radioCups=[],this._UID=helpers.createUID(),this.onClickAway=()=>{}}letterComesAfterLastInSet(value){return value>this.radioCups[this.radioCups.length-1].letter}addRadioCup(rc){var radioSet,rs;this.radioCups.push(rc),rc.setEvent("onclick",(rs=radioSet=this,()=>{rs.onClickAway()})),rc.setAttribute("name",this._UID)}setOnClickAway(func){this.onClickAway=func}get checkedRadio(){return this.radioCups.find(rc=>rc.getAttribute("checked"))}getValue(){let found=this.checkedRadio;return null==found?"":found.letter}setValue(value){this.radioCups.forEach(rc=>{rc.setAttribute("checked",rc.letter==value)})}get UID(){return this._UID}destroy(){this.radioCups.forEach(c=>{c.destroy()})}setDecisionImage(value){this.radioCups.forEach(r=>{r.getAttribute("checked")?r._decisionImage.setIconName(value):r._decisionImage.setIconName(IconName.none)})}setErrorText(value){this.radioCups.forEach(r=>{r.getAttribute("checked")&&(r.errorText.innerHTML=value,value.length>0&&r._decisionImage.setIconName(IconName.error))})}resetError(){this.radioCups.forEach(r=>{r.errorText.innerHTML="",r._decisionImage.getIconName()==IconName.error&&r._decisionImage.setIconName(IconName.none)})}setAttribute(name,value){this.radioCups.forEach(r=>r.setAttribute(name,value))}}class RadioCup extends ICup{constructor(parent,letter,decisionImage,span){super(parent,"input"),this.setAttribute("type","radio"),this.letter=letter,this._decisionImage=decisionImage,this.errorText=span,this.errorText.addClass("errorText")}get outerHTML(){return this.letter+". "+super.outerHTML}}class CheckBoxCup extends Icon{constructor(parent,iconName,span){super(parent,iconName),this.errorText=span,this.errorText.addClass("errorText")}setDecisionImage(value){this.setIconName(value)}setValue(value){}getValue(){return""}setErrorText(value){this.errorText.innerHTML=value,value.length>0&&this.setDecisionImage(IconName.error)}resetError(){this.errorText.innerHTML="",this.getIconName()==IconName.error&&this.setDecisionImage(IconName.none)}}class DollarCup extends Container{constructor(parent,span){super(parent,"div"),this.classes.push("dollarCup"),this.errorText=span,this.errorText.addClass("errorText")}setValue(value){this.destroyAllChildren(),this.appendChildString(value);for(let replacer of ContentDiv.replacers)this.replace(replacer);this.getElement(!1)&&(this._element.innerHTML=this.innerHTML)}getValue(){return this.innerHTML}swapForInput(){let parent=this._parent,decisionImage=new Icon(parent,IconName.none),span=new Span(parent,""),input=new InputCup(parent,3,decisionImage,span),index=parent._childNodes.indexOf(this);return parent._childNodes.splice(index,2,input,decisionImage,span),input}setErrorText(value){this.errorText.innerHTML=value}resetError(){this.errorText.innerHTML=""}}class ScoreLogic{constructor(setImageField,settings,questionDiv){this.pending=!1,ScoreLogic.instances.push(this),this.settings=settings,this.setImageField=setImageField,this.questionDiv instanceof QuestionDiv&&(this.questionDiv=questionDiv),this._score=0,this.hasBeenWrong=!1,this.hasBeenCorrect=!1}get stars(){return this.hasBeenCorrect&&!this.hasBeenWrong?1:0}get attempted(){return this.hasBeenCorrect||this.hasBeenWrong?1:0}get outOf(){return 1}get score(){return this._score}setCorrect(isCorrect){this._score=isCorrect?1:0,0==this.attempted&&this.settings.initialChecksRemaining<0||this.settings.instantChecking?this.setImage():(this.setImageField.setDecisionImage(IconName.hourglass),this.pending=!0,this.settings.initialChecksRemaining<0&&ScoreLogic.showHourGlassNotification&&(alert("To check an answer after the first attempt, you must use the 'check answers button' at the bottom of the page."),ScoreLogic.showHourGlassNotification=!1)),isCorrect?this.hasBeenCorrect=!0:this.hasBeenWrong=!0}setImage(){if(this.setImageField.setDecisionImage(this.iconName),this.pending=!1,this.questionDiv){let sameQuestionSLs,wrongOnes;0==ScoreLogic.instances.filter(sl=>sl.questionDiv==this.questionDiv).filter(sl=>0==sl.score).length?(this.questionDiv.marginDiv.addClass("greenBackground"),this.questionDiv.marginDiv.removeClass("greyBackground"),this.questionDiv.addClass("greenBorder"),this.questionDiv.removeClass("greyBorder")):(this.questionDiv.marginDiv.addClass("greyBackground"),this.questionDiv.marginDiv.removeClass("greenBackground"),this.questionDiv.addClass("greyBorder"),this.questionDiv.removeClass("greenBorder"))}}get iconName(){return 1==this._score?this.hasBeenWrong?IconName.tick:IconName.star:0==this._score?IconName.cross:void 0}get color(){return 1==this._score?this.hasBeenWrong?"LimeGreen":"LightGreen":0==this._score?this.hasBeenCorrect||this.hasBeenWrong?"LightSalmon":"White":void 0}get iconAsString(){return 1==this._score?this.hasBeenWrong?"✓":"★":0==this._score?this.hasBeenCorrect||this.hasBeenWrong?"✗":"White":void 0}destroy(){helpers.removeFromArray(ScoreLogic.instances,this)}}ScoreLogic.showHourGlassNotification=!0,ScoreLogic.instances=[],function(Mode){Mode[Mode.builder=0]="builder",Mode[Mode["lesson-student"]=1]="lesson-student",Mode[Mode["lesson-teacher"]=2]="lesson-teacher",Mode[Mode["present-teacher"]=3]="present-teacher",Mode[Mode["preview-teacher"]=4]="preview-teacher"}(Mode||(Mode={}));class Settings{constructor(settingsObj,mode){if(this.appendMode=!1,this.endTime=null,this.initialChecksRemaining=-1,this.questionJSON="",this.removeHyperlinks=!1,this.responses=[],this.shuffleQuestions=!1,this.startTime=null,this.seed=1,this.title="",this.truncateMarks=-1,Settings.instance)throw"only one of instance of Settings is allowed";for(var key in Settings.instance=this,window.cupsById={},settingsObj)this[key]=settingsObj[key];this.setDefaults(mode),this.sheetManager=new SheetManager,this.startTime&&(this.startTime=new Date(this.startTime)),this.endTime&&(this.endTime=new Date(this.endTime)),this.endTime&&(this.timerLogic=new TimerLogic(this.endTime,this)),settingsObj.studentNames?(this.setDefaults(Mode["lesson-teacher"]),this.studentPicker=new StudentPickerLogic(this,settingsObj.studentNames),this.responses=settingsObj.responses,this.random=new Random(Number(settingsObj.responses.Seed))):this.random=settingsObj.seed?new Random(Number(settingsObj.seed)):new Random}setDefaults(mode){this.allowRowDelete=[!0,!1,!1,!1,!0][mode],this.allowRowDuplicate=[!0,!1,!1,!1,!0][mode],this.allowRefresh=[!0,!1,!0,!0,!0][mode],this.allowGridlines=[!1,!1,!1,!1,!0][mode],this.instantChecking=[!0,!1,!0,!0,!0][mode],this.presentMode=[!1,!1,!1,!0,!1][mode],this.sendScoresToMarksheet=[!1,!0,!1,!1,!1][mode],this.showSolutions=[!0,!1,!0,!1,!0][mode]}get totalStars(){return ScoreLogic.instances.reduce((a,b)=>a+b.stars,0)}get totalAttempted(){return ScoreLogic.instances.reduce((a,b)=>a+b.attempted,0)}get totalOutOf(){return ScoreLogic.instances.reduce((a,b)=>a+b.outOf,0)}get totalCorrect(){return ScoreLogic.instances.reduce((a,b)=>a+b.score,0)}get totalScores(){return{Correct:{value:this.totalCorrect},Attempted:{value:this.totalAttempted},Stars:{value:this.totalStars},"Out of":{value:this.totalOutOf}}}disableAllInputs(){CommentLogic.instances.forEach(c=>c.disable())}}class SheetManager{constructor(){this.numberOfFieldsWithQuestionTitles={},this.columnHeadersWithFieldUIDs={},this.scoresToSendBuffer={},this.timerInterval=null}registerField(valueField,columnHeaderFirstPart,jsFunctionName){columnHeaderFirstPart in this.numberOfFieldsWithQuestionTitles||(this.numberOfFieldsWithQuestionTitles[columnHeaderFirstPart]=0);let letter,columnHeader=columnHeaderFirstPart+"."+(jsFunctionName||helpers.lowerCaseLetterFromIndex(this.numberOfFieldsWithQuestionTitles[columnHeaderFirstPart]++));this.columnHeadersWithFieldUIDs[valueField.UID]=columnHeader,Settings.instance.responses&&columnHeader in Settings.instance.responses&&valueField.setValue(Settings.instance.responses[columnHeader])}addFieldToSendBuffer(field,scoreLogic){let columnHeader=this.columnHeadersWithFieldUIDs[field.UID];columnHeader&&(this.scoresToSendBuffer[columnHeader]=scoreLogic?field instanceof CheckBoxCup?{value:scoreLogic.iconAsString,color:scoreLogic.color,append:Settings.instance.appendMode}:{value:field.getValue(),color:scoreLogic.color,append:Settings.instance.appendMode}:{value:field.getValue(),color:"white",append:Settings.instance.appendMode})}addScoresToBuffer(scores){this.scoresToSendBuffer=helpers.mergeObjects(this.scoresToSendBuffer,scores)}attemptToSend(){let merged=helpers.mergeObjects(Settings.instance.totalScores,this.scoresToSendBuffer),onSuccess=data=>{this.scoresToSendBuffer={},this.span.innerHTML=""},onRetry=data=>{this.span.innerHTML="connection error....retrying"};Connection.instance.writeToSheet(onSuccess.bind(this),onRetry.bind(this),merged)}createCountdownDiv(parent){return this.div=new Container(parent,"div"),this.div.addClass("sheetManagerCountdown"),this.span=new Span(this.div,""),this.div.appendChildElement(this.span),this.div}}class SolutionDiv extends Container{constructor(parent,questionNumberLogic,commentLogic){super(parent,"div"),this.classes.push("solution"),commentLogic&&commentLogic.createAndAppendSolutions(this,questionNumberLogic)}}class StudentPickerLogic{constructor(settings,studentNames){this.settings=settings,this.studentNames=studentNames}createCombo(parent){return this.combo=new ComboCup(parent,[],new Icon(parent,IconName.none),new Span(parent,"")),this.combo._childNodes=this.studentNames.map(s=>new OptionCup(this.combo,s,!1)),this.combo.setOnClickAway(this.comboClick.bind(this)),this.combo}comboClick(){this.combo.errorText.innerHTML="";let student=this.combo.getValue();console.log(student);let onRetry=data=>{this.combo.errorText.innerHTML="connection error...please try again"};Connection.instance.getMarkbookSettings(this.updateUser.bind(this),onRetry,student)}updateUser(markbookSettings){if(this.combo.errorText.innerHTML="",!(markbookSettings&&markbookSettings.responses&&markbookSettings.responses.Seed))throw"seed not found";{let seed=markbookSettings.responses.Seed;Settings.instance.random=new Random(seed),Settings.instance.assignment.resetQuestionOrder(),Settings.instance.shuffleQuestions&&Settings.instance.assignment.shuffle(!0),Settings.instance.assignment.regenerateAllQuestions()}}}class SubmitButtonAndFinalScoreLogic{constructor(settings){this.settings=settings}createDiv(parent){return this.div=new Container(parent,"div"),0==this.settings.initialChecksRemaining?(this.div.appendChildElement(this.createFinalScore(this.div)),ScoreLogic.instances.forEach(sc=>sc.setImage()),this.settings.disableAllInputs()):this.div.appendChildElement(this.createButton(this.div,this.settings.initialChecksRemaining)),this.div}createButton(parent,numChecks){return this.button=new ButtonCup(parent,this.buttonText(numChecks)),this.button.addClass("submitButton"),this.button.setEvent("onclick",this.onCheckButton.bind(this)),this.button}createFinalScore(parent){return this.finalScore=new HeadingCup(this.div,`FINAL SCORE: ${this.settings.totalCorrect} out of ${this.settings.totalOutOf}</h1>`),this.finalScore.addClass("finalScore"),this.finalScore}buttonText(numChecks){return numChecks<1?"check my answers":numChecks<1?"no checks remaining":1==numChecks?"I am finished. Check my answers then freeze the quiz":numChecks+" checks remaining"}onCheckButton(){if(this.settings.initialChecksRemaining>=0){this.button.setAttribute("disabled",!0);let onRetry=data=>{this.button.innerHTML="connection error....retrying"};Connection.instance.checkRequest(this.checkCallback.bind(this),onRetry.bind(this))}else ScoreLogic.instances.forEach(s=>{s.pending&&s.setImage()})}checkCallback(checksRemaining){this.button.innerHTML=this.buttonText(checksRemaining),this.button.setAttribute("disabled",!1),this.button&&(this.button.setAttribute("value",this.buttonText),0==checksRemaining&&(this.button.destroy(),this.div.appendChildElement(this.createFinalScore(this.div)),ScoreLogic.instances.forEach(sc=>sc.setImage()),this.settings.disableAllInputs()))}}class TimerLogic{constructor(endTime,settings){this.endTime=endTime,this.settings=settings}createDiv(parent){var timer;return this.div=new Container(parent,"div"),this.div.addClass("timer"),this.span=new Span(this.div,""),this.div.appendChildElement(this.span),this.timerInterval=setInterval((timer=timer=this,function(){timer.span.innerHTML=timer.timerText,timer.isElapsed&&(timer.div.addClass("red"),clearInterval(timer.timerInterval),timer.settings.disableAllInputs())}),900),this.div}get timerText(){if(this.isElapsed)return"TIME EXPIRED";var delta=Math.abs(Number(this.endTime)-Number(new Date))/1e3,days=Math.floor(delta/86400),daysString=0==days?"":days.toString()+" d ";delta-=86400*days;var hours=Math.floor(delta/3600)%24,hoursString=0==hours?"":hours.toString()+" h ";delta-=3600*hours;var minutes=Math.floor(delta/60)%60,minutesString=minutes.toString()+" m ",seconds,secondsString;return delta-=60*minutes,daysString+hoursString+minutesString+(Math.floor(delta%60).toString()+" s")}get isElapsed(){return Number(this.endTime)<Number(new Date)}}